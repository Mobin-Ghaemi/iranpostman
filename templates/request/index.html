{% extends 'base.html' %}

{% block title %}Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ - Iran Postman{% endblock %}

{% block extra_css %}
<style>
    .hero-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 40px 0;
        border-radius: 20px;
        margin-bottom: 30px;
    }
    
    .stats-card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        border: none;
        height: 100%;
    }
    
    .stats-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 40px rgba(0,0,0,0.15);
    }
    
    .stats-icon {
        width: 60px;
        height: 60px;
        border-radius: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        margin-bottom: 15px;
    }
    
    .quick-action-card {
        background: white;
        border-radius: 15px;
        padding: 20px;
        text-align: center;
        transition: all 0.3s ease;
        border: none;
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        height: 100%;
    }
    
    .quick-action-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 15px 30px rgba(0,0,0,0.15);
    }
    
    .request-builder-card {
        background: white;
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }
    
    .form-control, .form-select {
        border-radius: 10px;
        border: 2px solid #e9ecef;
        padding: 12px 15px;
        transition: all 0.3s ease;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }
    
    .btn-primary {
        background: linear-gradient(45deg, #667eea, #764ba2);
        border: none;
        border-radius: 10px;
        padding: 12px 25px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-primary:hover {
        background: linear-gradient(45deg, #5a6fd8, #6a4190);
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }
    
    .nav-tabs .nav-link {
        border-radius: 10px 10px 0 0;
        border: none;
        padding: 12px 20px;
        margin-right: 5px;
        background: #f8f9fa;
        color: #6c757d;
        transition: all 0.3s ease;
    }
    
    .nav-tabs .nav-link.active {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
    }
    
    .response-card {
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        border: none;
    }
    
    .history-card {
        background: white;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        border: none;
    }
    
    .badge {
        padding: 8px 12px;
        border-radius: 8px;
        font-weight: 600;
    }
    
    .json-tools {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 15px;
        margin-top: 10px;
    }
    
    .url-preview {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 10px;
        padding: 15px;
        border: 2px dashed #dee2e6;
    }
    
    .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255,255,255,.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    .feature-highlight {
        background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #fecfef 100%);
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        color: #333;
    }
</style>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<div class="hero-section text-center">
    <div class="container">
        <h1 class="display-4 fw-bold mb-3">
            <i class="bi bi-lightning-charge-fill"></i>
            Iran Postman
        </h1>
        <p class="lead mb-4">Ø§Ø¨Ø²Ø§Ø± Ù‚Ø¯Ø±ØªÙ…Ù†Ø¯ ØªØ³Øª API Ø¨Ø§ Ø±Ø§Ø¨Ø· Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø²ÛŒØ¨Ø§ Ùˆ Ø§Ù…Ú©Ø§Ù†Ø§Øª Ù¾ÛŒØ´Ø±ÙØªÙ‡</p>
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="d-flex justify-content-center gap-3">
                    <span class="badge bg-light text-dark px-3 py-2">
                        <i class="bi bi-check-circle-fill text-success"></i> Ø³Ø±ÛŒØ¹ Ùˆ Ù‚Ø¯Ø±ØªÙ…Ù†Ø¯
                    </span>
                    <span class="badge bg-light text-dark px-3 py-2">
                        <i class="bi bi-shield-check-fill text-primary"></i> Ø§Ù…Ù† Ùˆ Ù‚Ø§Ø¨Ù„ Ø§Ø¹ØªÙ…Ø§Ø¯
                    </span>
                    <span class="badge bg-light text-dark px-3 py-2">
                        <i class="bi bi-heart-fill text-danger"></i> Ø³Ø§Ø®Øª Ø§ÛŒØ±Ø§Ù†
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ -->
<div class="row mb-5" id="stats-row">
    <div class="col-md-6 mb-4">
        <div class="stats-card">
            <div class="d-flex align-items-center">
                <div class="stats-icon bg-primary bg-gradient text-white">
                    <i class="bi bi-folder"></i>
                </div>
                <div class="ms-3 flex-grow-1">
                    <h3 class="mb-1 fw-bold text-primary" id="total-collections">-</h3>
                    <h6 class="text-muted mb-1">Ú©Ø§Ù„Ú©Ø´Ù†â€ŒÙ‡Ø§</h6>
                    <small class="text-muted">Ø³Ø§Ø²Ù…Ø§Ù†Ø¯Ù‡ÛŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§</small>
                </div>
                <div class="text-end">
                    <a href="{% url 'request:collections' %}" class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-arrow-left"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-4">
        <div class="stats-card">
            <div class="d-flex align-items-center">
                <div class="stats-icon bg-success bg-gradient text-white">
                    <i class="bi bi-gear-wide-connected"></i>
                </div>
                <div class="ms-3 flex-grow-1">
                    <h3 class="mb-1 fw-bold text-success" id="total-environments">-</h3>
                    <h6 class="text-muted mb-1">Ù…Ø­ÛŒØ·â€ŒÙ‡Ø§</h6>
                    <small class="text-muted">Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ù‚Ø§Ø¨Ù„ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…Ø¬Ø¯Ø¯</small>
                </div>
                <div class="text-end">
                    <a href="{% url 'request:environments' %}" class="btn btn-outline-success btn-sm">
                        <i class="bi bi-arrow-left"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Ù…ÛŒØ§Ù†Ø¨Ø±Ù‡Ø§ÛŒ Ø³Ø±ÛŒØ¹ -->
<div class="row mb-5">
    <div class="col-md-4 mb-3">
        <div class="quick-action-card">
            <div class="mb-3">
                <div class="stats-icon bg-info bg-gradient text-white mx-auto">
                    <i class="bi bi-folder-plus"></i>
                </div>
            </div>
            <h5 class="fw-bold mb-2">Ú©Ø§Ù„Ú©Ø´Ù† Ø¬Ø¯ÛŒØ¯</h5>
            <p class="text-muted mb-3">Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ø±ØªØ¨Ø· Ø±Ø§ Ø³Ø§Ø²Ù…Ø§Ù†Ø¯Ù‡ÛŒ Ú©Ù†ÛŒØ¯</p>
            <a href="{% url 'request:collections' %}" class="btn btn-info">
                <i class="bi bi-plus"></i> Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ù„Ú©Ø´Ù†
            </a>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="quick-action-card">
            <div class="mb-3">
                <div class="stats-icon bg-warning bg-gradient text-white mx-auto">
                    <i class="bi bi-gear-wide"></i>
                </div>
            </div>
            <h5 class="fw-bold mb-2">Ù…Ø­ÛŒØ· Ø¬Ø¯ÛŒØ¯</h5>
            <p class="text-muted mb-3">Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ù…Ø­ÛŒØ· Ø±Ø§ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ù†ÛŒØ¯</p>
            <a href="{% url 'request:environments' %}" class="btn btn-warning">
                <i class="bi bi-plus"></i> Ø§ÛŒØ¬Ø§Ø¯ Ù…Ø­ÛŒØ·
            </a>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="quick-action-card">
            <div class="mb-3">
                <div class="stats-icon bg-secondary bg-gradient text-white mx-auto">
                    <i class="bi bi-clock-history"></i>
                </div>
            </div>
            <h5 class="fw-bold mb-2">ØªØ§Ø±ÛŒØ®Ú†Ù‡</h5>
            <p class="text-muted mb-3">Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ Ø±Ø§ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ú©Ù†ÛŒØ¯</p>
            <a href="{% url 'request:history' %}" class="btn btn-secondary">
                <i class="bi bi-eye"></i> Ù…Ø´Ø§Ù‡Ø¯Ù‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡
            </a>
        </div>
    </div>
</div>

<!-- ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ø¨Ø±Ø¬Ø³ØªÙ‡ -->
<div class="feature-highlight">
    <div class="row align-items-center">
        <div class="col-md-8">
            <h4 class="fw-bold mb-2">
                <i class="bi bi-stars"></i> ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Iran Postman
            </h4>
            <p class="mb-0">
                ØªØµØ­ÛŒØ­ Ø®ÙˆØ¯Ú©Ø§Ø± JSONØŒ Ø§Ø¬Ø±Ø§ÛŒ Ù…Ø¬Ø¯Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ØŒ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ù„Ú©Ø´Ù†â€ŒÙ‡Ø§ Ùˆ Ù…Ø­ÛŒØ·â€ŒÙ‡Ø§ØŒ 
                Ùˆ Ø±Ø§Ø¨Ø· Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø²ÛŒØ¨Ø§ Ø¨Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ú©Ø§Ù…Ù„ Ø§Ø² Ø²Ø¨Ø§Ù† ÙØ§Ø±Ø³ÛŒ
            </p>
        </div>
        <div class="col-md-4 text-center">
            <i class="bi bi-rocket-takeoff display-1 text-primary"></i>
        </div>
    </div>
</div>

<!-- Ø³Ø§Ø²Ù†Ø¯Ù‡ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø³Ø±ÛŒØ¹ -->
<div class="request-builder-card mb-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="fw-bold mb-0">
            <i class="bi bi-play-circle text-primary"></i> Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø³Ø±ÛŒØ¹
        </h4>
        <span class="badge bg-primary">Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³ØªÙØ§Ø¯Ù‡</span>
    </div>
    
    <form id="quick-request-form">
        {% csrf_token %}
        
        <!-- URL Ùˆ Method -->
        <div class="row mb-4">
            <div class="col-md-2">
                <select class="form-select" id="method" name="method">
                    <option value="GET">GET</option>
                    <option value="POST">POST</option>
                    <option value="PUT">PUT</option>
                    <option value="PATCH">PATCH</option>
                    <option value="DELETE">DELETE</option>
                    <option value="HEAD">HEAD</option>
                    <option value="OPTIONS">OPTIONS</option>
                </select>
            </div>
            <div class="col-md-8">
                <input type="url" class="form-control" id="url" name="url" 
                       placeholder="https://api.example.com/endpoint" required>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100" id="send-btn">
                    <i class="bi bi-send"></i> Ø§Ø±Ø³Ø§Ù„
                </button>
            </div>
        </div>
        
        <!-- Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ URL Ù†Ù‡Ø§ÛŒÛŒ -->
        <div class="url-preview mb-4">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <small class="fw-bold text-muted">
                    <i class="bi bi-link-45deg"></i> URL Ù†Ù‡Ø§ÛŒÛŒ:
                </small>
                <button type="button" class="btn btn-outline-secondary btn-sm" id="copy-url" title="Ú©Ù¾ÛŒ URL">
                    <i class="bi bi-clipboard"></i> Ú©Ù¾ÛŒ
                </button>
            </div>
            <code id="final-url" class="text-break d-block">URL Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯...</code>
        </div>

        <!-- ØªØ¨â€ŒÙ‡Ø§ -->
        <ul class="nav nav-tabs mb-4" id="requestTabs">
            <li class="nav-item">
                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#params-tab">
                    <i class="bi bi-list-ul"></i> Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#headers-tab">
                    <i class="bi bi-tags"></i> Ù‡Ø¯Ø±Ù‡Ø§
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#body-tab">
                    <i class="bi bi-file-text"></i> Ø¨Ø¯Ù†Ù‡
                </button>
            </li>
        </ul>

        <div class="tab-content">
            <!-- Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ -->
            <div class="tab-pane fade show active" id="params-tab">
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0 fw-bold">Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ÛŒ URL</h6>
                        <small class="text-muted">Ø§ÛŒÙ† Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ Ø¨Ù‡ Ø§Ù†ØªÙ‡Ø§ÛŒ URL Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯</small>
                    </div>
                    <div id="params-container">
                        <div class="row mb-2 param-row">
                            <div class="col-md-4">
                                <input type="text" class="form-control param-key" placeholder="Ù†Ø§Ù… Ù¾Ø§Ø±Ø§Ù…ØªØ± (Ù…Ø«Ø§Ù„: page)">
                            </div>
                            <div class="col-md-6">
                                <input type="text" class="form-control param-value" placeholder="Ù…Ù‚Ø¯Ø§Ø± (Ù…Ø«Ø§Ù„: 1)">
                            </div>
                            <div class="col-md-1">
                                <div class="form-check">
                                    <input class="form-check-input param-enabled" type="checkbox" checked title="ÙØ¹Ø§Ù„/ØºÛŒØ±ÙØ¹Ø§Ù„">
                                </div>
                            </div>
                            <div class="col-md-1">
                                <button type="button" class="btn btn-outline-danger btn-sm remove-param" title="Ø­Ø°Ù Ù¾Ø§Ø±Ø§Ù…ØªØ±">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-outline-primary btn-sm" id="add-param">
                        <i class="bi bi-plus"></i> Ø§ÙØ²ÙˆØ¯Ù† Ù¾Ø§Ø±Ø§Ù…ØªØ±
                    </button>
                </div>
            </div>

            <!-- Ù‡Ø¯Ø±Ù‡Ø§ -->
            <div class="tab-pane fade" id="headers-tab">
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0 fw-bold">Ù‡Ø¯Ø±Ù‡Ø§ÛŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øª</h6>
                        <div class="dropdown">
                            <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <i class="bi bi-plus-square"></i> Ù‡Ø¯Ø±Ù‡Ø§ÛŒ Ø±Ø§ÛŒØ¬
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item common-header" data-key="Content-Type" data-value="application/json">Content-Type: application/json</a></li>
                                <li><a class="dropdown-item common-header" data-key="Content-Type" data-value="application/x-www-form-urlencoded">Content-Type: form-urlencoded</a></li>
                                <li><a class="dropdown-item common-header" data-key="Content-Type" data-value="multipart/form-data">Content-Type: multipart/form-data</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item common-header" data-key="Authorization" data-value="Bearer ">Authorization: Bearer Token</a></li>
                                <li><a class="dropdown-item common-header" data-key="Authorization" data-value="Basic ">Authorization: Basic Auth</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item common-header" data-key="Accept" data-value="application/json">Accept: application/json</a></li>
                                <li><a class="dropdown-item common-header" data-key="User-Agent" data-value="Iran-Postman/1.0">User-Agent: Iran-Postman</a></li>
                                <li><a class="dropdown-item common-header" data-key="X-Requested-With" data-value="XMLHttpRequest">X-Requested-With: XMLHttpRequest</a></li>
                            </ul>
                        </div>
                    </div>
                    <div id="headers-container">
                        <div class="row mb-2 header-row">
                            <div class="col-md-4">
                                <input type="text" class="form-control header-key" placeholder="Ù†Ø§Ù… Ù‡Ø¯Ø± (Ù…Ø«Ø§Ù„: Content-Type)" list="header-suggestions">
                                <datalist id="header-suggestions">
                                    <option value="Content-Type">
                                    <option value="Authorization">
                                    <option value="Accept">
                                    <option value="User-Agent">
                                    <option value="X-API-Key">
                                    <option value="X-Requested-With">
                                    <option value="Cache-Control">
                                    <option value="Accept-Language">
                                </datalist>
                            </div>
                            <div class="col-md-6">
                                <input type="text" class="form-control header-value" placeholder="Ù…Ù‚Ø¯Ø§Ø± Ù‡Ø¯Ø± (Ù…Ø«Ø§Ù„: application/json)">
                            </div>
                            <div class="col-md-1">
                                <div class="form-check">
                                    <input class="form-check-input header-enabled" type="checkbox" checked title="ÙØ¹Ø§Ù„/ØºÛŒØ±ÙØ¹Ø§Ù„">
                                </div>
                            </div>
                            <div class="col-md-1">
                                <button type="button" class="btn btn-outline-danger btn-sm remove-header" title="Ø­Ø°Ù Ù‡Ø¯Ø±">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-outline-primary btn-sm" id="add-header">
                        <i class="bi bi-plus"></i> Ø§ÙØ²ÙˆØ¯Ù† Ù‡Ø¯Ø±
                    </button>
                </div>
            </div>

            <!-- Ø¨Ø¯Ù†Ù‡ -->
            <div class="tab-pane fade" id="body-tab">
                <div class="mb-3">
                    <h6 class="fw-bold mb-3">Ù†ÙˆØ¹ Ø¨Ø¯Ù†Ù‡ Ø¯Ø±Ø®ÙˆØ§Ø³Øª</h6>
                    <select class="form-select" id="body-type" name="body_type">
                        <option value="none">Ù‡ÛŒÚ†</option>
                        <option value="raw">Ù…ØªÙ† Ø®Ø§Ù… (Raw)</option>
                        <option value="form-data">Form Data</option>
                        <option value="x-www-form-urlencoded">URL Encoded</option>
                    </select>
                </div>
                
                <div id="body-content">
                    <div id="body-raw-section" style="display: none;">
                        <div class="mb-3 d-flex justify-content-between align-items-center">
                            <h6 class="mb-0 fw-bold">Ù…Ø­ØªÙˆØ§ÛŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øª</h6>
                            <div class="btn-group" role="group">
                                <input type="radio" class="btn-check" name="raw-type" id="raw-text" value="text" checked>
                                <label class="btn btn-outline-secondary btn-sm" for="raw-text">Text</label>
                                
                                <input type="radio" class="btn-check" name="raw-type" id="raw-json" value="json">
                                <label class="btn btn-outline-secondary btn-sm" for="raw-json">JSON</label>
                                
                                <input type="radio" class="btn-check" name="raw-type" id="raw-xml" value="xml">
                                <label class="btn btn-outline-secondary btn-sm" for="raw-xml">XML</label>
                                
                                <input type="radio" class="btn-check" name="raw-type" id="raw-html" value="html">
                                <label class="btn btn-outline-secondary btn-sm" for="raw-html">HTML</label>
                            </div>
                        </div>
                        <textarea class="form-control font-monospace" id="body-raw" rows="12" 
                                  placeholder="Ù…Ø­ØªÙˆØ§ÛŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯..." style="resize: vertical;"></textarea>
                        
                        <div class="json-tools">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <div class="btn-group me-3" role="group">
                                        <button type="button" class="btn btn-outline-info btn-sm" id="format-json">
                                            <i class="bi bi-code"></i> ÙØ±Ù…Øª JSON
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary btn-sm" id="minify-json">
                                            <i class="bi bi-arrows-collapse"></i> ÙØ´Ø±Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ
                                        </button>
                                        <button type="button" class="btn btn-outline-warning btn-sm" id="validate-json">
                                            <i class="bi bi-check-circle"></i> Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ
                                        </button>
                                        <button type="button" class="btn btn-outline-success btn-sm" id="fix-json">
                                            <i class="bi bi-tools"></i> ØªØµØ­ÛŒØ­ Ø®ÙˆØ¯Ú©Ø§Ø±
                                        </button>
                                        <button type="button" class="btn btn-outline-primary btn-sm" id="create-json">
                                            <i class="bi bi-plus-circle"></i> Ø³Ø§Ø®Øª JSON
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-4 text-end">
                                    <small class="text-muted">
                                        <span id="char-count">0</span> Ú©Ø§Ø±Ø§Ú©ØªØ± | 
                                        <span id="line-count">1</span> Ø®Ø·
                                    </small>
                                    <br>
                                    <small id="json-status" class="text-muted">ÙˆØ¶Ø¹ÛŒØª: Ù†Ø§Ù…Ø´Ø®Øµ</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="body-form-data-section" style="display: none;">
                        <div class="mb-3">
                            <h6 class="fw-bold mb-3">Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ÙØ±Ù…</h6>
                            <div id="form-data-container">
                                <div class="row mb-2 form-data-row">
                                    <div class="col-md-4">
                                        <input type="text" class="form-control form-data-key" placeholder="Ù†Ø§Ù… ÙÛŒÙ„Ø¯">
                                    </div>
                                    <div class="col-md-2">
                                        <select class="form-select form-data-type">
                                            <option value="text">Text</option>
                                            <option value="file">File</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <input type="text" class="form-control form-data-value" placeholder="Ù…Ù‚Ø¯Ø§Ø±">
                                        <input type="file" class="form-control form-data-file" style="display: none;">
                                    </div>
                                    <div class="col-md-1">
                                        <div class="form-check">
                                            <input class="form-check-input form-data-enabled" type="checkbox" checked>
                                        </div>
                                    </div>
                                    <div class="col-md-1">
                                        <button type="button" class="btn btn-outline-danger btn-sm remove-form-data">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-outline-primary btn-sm" id="add-form-data">
                                <i class="bi bi-plus"></i> Ø§ÙØ²ÙˆØ¯Ù† ÙÛŒÙ„Ø¯
                            </button>
                        </div>
                    </div>
                    
                    <div id="body-urlencoded-section" style="display: none;">
                        <div class="mb-3">
                            <h6 class="fw-bold mb-3">Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ URL Encoded</h6>
                            <div id="urlencoded-container">
                                <div class="row mb-2 urlencoded-row">
                                    <div class="col-md-5">
                                        <input type="text" class="form-control urlencoded-key" placeholder="Ù†Ø§Ù… Ù¾Ø§Ø±Ø§Ù…ØªØ±">
                                    </div>
                                    <div class="col-md-5">
                                        <input type="text" class="form-control urlencoded-value" placeholder="Ù…Ù‚Ø¯Ø§Ø±">
                                    </div>
                                    <div class="col-md-1">
                                        <div class="form-check">
                                            <input class="form-check-input urlencoded-enabled" type="checkbox" checked>
                                        </div>
                                    </div>
                                    <div class="col-md-1">
                                        <button type="button" class="btn btn-outline-danger btn-sm remove-urlencoded">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-outline-primary btn-sm" id="add-urlencoded">
                                <i class="bi bi-plus"></i> Ø§ÙØ²ÙˆØ¯Ù† Ù¾Ø§Ø±Ø§Ù…ØªØ±
                            </button>
                        </div>
                    </div>
                    
                    <div id="body-none-section">
                        <div class="text-center p-5 text-muted">
                            <i class="bi bi-info-circle display-4 mb-3"></i>
                            <h5>Ù‡ÛŒÚ† Ø¨Ø¯Ù†Ù‡â€ŒØ§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡</h5>
                            <p>Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø¯Ø§Ø¯Ù‡ØŒ Ù†ÙˆØ¹ Ø¨Ø¯Ù†Ù‡ Ø±Ø§ Ø§Ø² Ø¨Ø§Ù„Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Ù†Ù…Ø§ÛŒØ´ Ù¾Ø§Ø³Ø® -->
<div id="response-section" class="response-card" style="display: none;">
    <div class="card-header bg-gradient">
        <h5 class="mb-0 text-white">
            <i class="bi bi-arrow-down-circle"></i> Ù¾Ø§Ø³Ø® Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯Ù‡
        </h5>
    </div>
    <div class="card-body">
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="text-center">
                    <small class="text-muted d-block">Ú©Ø¯ ÙˆØ¶Ø¹ÛŒØª</small>
                    <span id="response-status" class="badge fs-6"></span>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <small class="text-muted d-block">Ø²Ù…Ø§Ù† Ù¾Ø§Ø³Ø®</small>
                    <strong id="response-time"></strong>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <small class="text-muted d-block">Ø§Ù†Ø¯Ø§Ø²Ù‡</small>
                    <strong id="response-size"></strong>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <button class="btn btn-outline-primary btn-sm" id="save-response">
                        <i class="bi bi-bookmark"></i> Ø°Ø®ÛŒØ±Ù‡ Ù¾Ø§Ø³Ø®
                    </button>
                </div>
            </div>
        </div>
        
        <ul class="nav nav-tabs mb-3">
            <li class="nav-item">
                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#response-body">
                    <i class="bi bi-file-text"></i> Ø¨Ø¯Ù†Ù‡ Ù¾Ø§Ø³Ø®
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#response-headers">
                    <i class="bi bi-tags"></i> Ù‡Ø¯Ø±Ù‡Ø§ÛŒ Ù¾Ø§Ø³Ø®
                </button>
            </li>
        </ul>
        
        <div class="tab-content">
            <div class="tab-pane fade show active" id="response-body">
                <pre id="response-body-content" class="bg-light p-3 rounded" style="max-height: 400px; overflow-y: auto;"></pre>
            </div>
            <div class="tab-pane fade" id="response-headers">
                <pre id="response-headers-content" class="bg-light p-3 rounded"></pre>
            </div>
        </div>
    </div>
</div>

<!-- ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø§Ø®ÛŒØ± -->
<div class="history-card mt-5">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
            <i class="bi bi-clock-history text-warning"></i> ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø§Ø®ÛŒØ±
        </h5>
        <a href="{% url 'request:history' %}" class="btn btn-outline-primary btn-sm">
            <i class="bi bi-arrow-left"></i> Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù‡Ù…Ù‡
        </a>
    </div>
    <div class="card-body">
        <div id="recent-history">
            <div class="text-center p-4">
                <div class="loading-spinner"></div>
                <p class="text-muted mt-2">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentHistoryId = null;

// Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¢Ù…Ø§Ø± Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
async function loadDashboardStats() {
    try {
        const response = await axios.get('/request/api/dashboard-stats/');
        const stats = response.data;
        
        document.getElementById('total-collections').textContent = stats.total_collections;
        document.getElementById('total-environments').textContent = stats.total_environments;
        
        // Ù†Ù…Ø§ÛŒØ´ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø§Ø®ÛŒØ±
        const recentHistory = document.getElementById('recent-history');
        if (stats.recent_requests.length === 0) {
            recentHistory.innerHTML = `
                <div class="text-center p-4 text-muted">
                    <i class="bi bi-inbox display-4 mb-3"></i>
                    <h5>Ù‡ÛŒÚ† ØªØ§Ø±ÛŒØ®Ú†Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</h5>
                    <p>Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§ÙˆÙ„ Ø®ÙˆØ¯ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯</p>
                </div>
            `;
        } else {
            recentHistory.innerHTML = stats.recent_requests.map(item => `
                <div class="d-flex justify-content-between align-items-center border-bottom py-3">
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center mb-1">
                            <span class="badge ${getMethodBadgeClass(item.method)} me-2">${item.method}</span>
                            <strong class="text-truncate">${item.request_name || 'Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø³Ø±ÛŒØ¹'}</strong>
                        </div>
                        <small class="text-muted text-truncate d-block">${item.url}</small>
                    </div>
                    <div class="text-end ms-3">
                        <span class="badge ${item.is_success ? 'bg-success' : 'bg-danger'} mb-1">${item.status_code || 'Ø®Ø·Ø§'}</span>
                        <br>
                        <small class="text-muted">${new Date(item.executed_at).toLocaleDateString('fa-IR')}</small>
                    </div>
                </div>
            `).join('');
        }
    } catch (error) {
        console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¢Ù…Ø§Ø±:', error);
        document.getElementById('recent-history').innerHTML = `
            <div class="text-center p-4 text-danger">
                <i class="bi bi-exclamation-triangle display-4 mb-3"></i>
                <h5>Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ</h5>
                <p>Ù„Ø·ÙØ§Ù‹ ØµÙØ­Ù‡ Ø±Ø§ ØªØ§Ø²Ù‡â€ŒØ³Ø§Ø²ÛŒ Ú©Ù†ÛŒØ¯</p>
            </div>
        `;
    }
}

// Ù…Ø¯ÛŒØ±ÛŒØª ØªØ¨â€ŒÙ‡Ø§ Ùˆ Ø¨Ø¯Ù†Ù‡
document.getElementById('body-type').addEventListener('change', function() {
    const bodyType = this.value;
    
    // Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† Ù‡Ù…Ù‡ Ø¨Ø®Ø´â€ŒÙ‡Ø§
    document.getElementById('body-none-section').style.display = 'none';
    document.getElementById('body-raw-section').style.display = 'none';
    document.getElementById('body-form-data-section').style.display = 'none';
    document.getElementById('body-urlencoded-section').style.display = 'none';
    
    // Ù†Ù…Ø§ÛŒØ´ Ø¨Ø®Ø´ Ù…Ø±Ø¨ÙˆØ·Ù‡
    if (bodyType === 'none') {
        document.getElementById('body-none-section').style.display = 'block';
    } else if (bodyType === 'raw') {
        document.getElementById('body-raw-section').style.display = 'block';
        updateCharCount();
    } else if (bodyType === 'form-data') {
        document.getElementById('body-form-data-section').style.display = 'block';
    } else if (bodyType === 'x-www-form-urlencoded') {
        document.getElementById('body-urlencoded-section').style.display = 'block';
    }
});

// Ø´Ù…Ø§Ø±Ø´ Ú©Ø§Ø±Ø§Ú©ØªØ± Ùˆ Ø®Ø· Ø¯Ø± Raw Body
function updateCharCount() {
    const textarea = document.getElementById('body-raw');
    const charCounter = document.getElementById('char-count');
    const lineCounter = document.getElementById('line-count');
    
    if (textarea && charCounter && lineCounter) {
        charCounter.textContent = textarea.value.length;
        lineCounter.textContent = textarea.value.split('\n').length;
        
        // Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª JSON
        updateJsonStatus();
    }
}

// Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª JSON
function updateJsonStatus() {
    const textarea = document.getElementById('body-raw');
    const statusElement = document.getElementById('json-status');
    
    if (!textarea || !statusElement) return;
    
    const content = textarea.value.trim();
    if (!content) {
        statusElement.innerHTML = '<span class="text-muted">ÙˆØ¶Ø¹ÛŒØª: Ø®Ø§Ù„ÛŒ</span>';
        return;
    }
    
    try {
        JSON.parse(content);
        statusElement.innerHTML = '<span class="text-success"><i class="bi bi-check-circle"></i> JSON Ù…Ø¹ØªØ¨Ø±</span>';
    } catch (e) {
        statusElement.innerHTML = '<span class="text-danger"><i class="bi bi-x-circle"></i> JSON Ù†Ø§Ù…Ø¹ØªØ¨Ø±</span>';
    }
}

// Event listener Ø¨Ø±Ø§ÛŒ Ø´Ù…Ø§Ø±Ø´ Ú©Ø§Ø±Ø§Ú©ØªØ± Ùˆ Ø¨Ø±Ø±Ø³ÛŒ JSON
document.addEventListener('input', function(e) {
    if (e.target.id === 'body-raw') {
        updateCharCount();
    }
});

// JSON Tools
document.addEventListener('click', function(e) {
    if (e.target.closest('#format-json')) {
        const textarea = document.getElementById('body-raw');
        try {
            const jsonData = JSON.parse(textarea.value);
            textarea.value = JSON.stringify(jsonData, null, 2);
            updateCharCount();
            showAlert('JSON Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ÙØ±Ù…Øª Ø´Ø¯!', 'success');
        } catch (error) {
            showAlert('ÙØ±Ù…Øª JSON Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª!', 'warning');
        }
    }
    
    if (e.target.closest('#minify-json')) {
        const textarea = document.getElementById('body-raw');
        try {
            const jsonData = JSON.parse(textarea.value);
            textarea.value = JSON.stringify(jsonData);
            updateCharCount();
            showAlert('JSON ÙØ´Ø±Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯!', 'success');
        } catch (error) {
            showAlert('ÙØ±Ù…Øª JSON Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª!', 'warning');
        }
    }
    
    if (e.target.closest('#validate-json')) {
        const textarea = document.getElementById('body-raw');
        const content = textarea.value.trim();
        
        if (!content) {
            showAlert('Ù…Ø­ØªÙˆØ§ÛŒ JSON Ø®Ø§Ù„ÛŒ Ø§Ø³Øª!', 'warning');
            return;
        }
        
        try {
            JSON.parse(content);
            showAlert('JSON Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª! âœ“', 'success');
        } catch (error) {
            showAlert(`JSON Ù†Ø§Ù…Ø¹ØªØ¨Ø±: ${error.message}`, 'danger');
        }
    }
    
    if (e.target.closest('#fix-json')) {
        const textarea = document.getElementById('body-raw');
        let content = textarea.value.trim();
        
        if (!content) {
            showAlert('Ù…Ø­ØªÙˆØ§ÛŒ JSON Ø®Ø§Ù„ÛŒ Ø§Ø³Øª!', 'warning');
            return;
        }
        
        // Smart JSON Converter - Ù‡Ø± Ú†ÛŒØ²ÛŒ Ø±Ø§ Ø¨Ù‡ JSON ØªØ¨Ø¯ÛŒÙ„ Ù…ÛŒâ€ŒÚ©Ù†Ø¯
        try {
            // Ø§Ø¨ØªØ¯Ø§ Ø³Ø¹ÛŒ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… JSON Ù…Ø¹ØªØ¨Ø± Ù¾Ø§Ø±Ø³ Ú©Ù†ÛŒÙ…
            const parsed = JSON.parse(content);
            textarea.value = JSON.stringify(parsed, null, 2);
            updateCharCount();
            showAlert('JSON ØªØµØ­ÛŒØ­ Ùˆ ÙØ±Ù…Øª Ø´Ø¯!', 'success');
            return;
        } catch (e) {
            // Ø§Ú¯Ø± JSON Ù†Ø¨ÙˆØ¯ØŒ ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ ØªØ¨Ø¯ÛŒÙ„ Ù‡ÙˆØ´Ù…Ù†Ø¯
        }
        
        try {
            let result;
            
            // Ø¨Ø±Ø±Ø³ÛŒ Ø§Ù†ÙˆØ§Ø¹ Ù…Ø®ØªÙ„Ù Ù…Ø­ØªÙˆØ§
            if (content.startsWith('{') || content.startsWith('[')) {
                // Ø§Ø­ØªÙ…Ø§Ù„Ø§Ù‹ JSON Ù…Ø¹ÛŒÙˆØ¨ Ø§Ø³Øª
                result = smartJsonFixer(content);
            } else if (content.includes('=') && (content.includes('&') || content.includes('\n'))) {
                // Ø§Ø­ØªÙ…Ø§Ù„Ø§Ù‹ query string ÛŒØ§ form data Ø§Ø³Øª
                result = parseQueryStringToJson(content);
            } else if (content.includes('\n') || content.includes(',')) {
                // Ø§Ø­ØªÙ…Ø§Ù„Ø§Ù‹ ÙÙ‡Ø±Ø³ØªÛŒ Ø§Ø² Ù…Ù‚Ø§Ø¯ÛŒØ± Ø§Ø³Øª
                result = parseListToJson(content);
            } else {
                // Ù…ØªÙ† Ø³Ø§Ø¯Ù‡ - Ø¨Ù‡ key/value Ø³Ø§Ø¯Ù‡ ØªØ¨Ø¯ÛŒÙ„ Ù…ÛŒâ€ŒØ´ÙˆØ¯
                result = {};
                result[promptForKey() || "value"] = content;
            }
            
            textarea.value = JSON.stringify(result, null, 2);
            updateCharCount();
            showAlert('Ù…Ø­ØªÙˆØ§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡ JSON ØªØ¨Ø¯ÛŒÙ„ Ø´Ø¯! ğŸ‰', 'success');
            
        } catch (error) {
            showAlert(`Ø®Ø·Ø§ Ø¯Ø± ØªØ¨Ø¯ÛŒÙ„: ${error.message}`, 'danger');
        }
    }
    
    if (e.target.closest('#create-json')) {
        createJsonBuilder();
    }
});

// ØªØ§Ø¨Ø¹ Ø¯Ø±Ø®ÙˆØ§Ø³Øª key Ø§Ø² Ú©Ø§Ø±Ø¨Ø±
function promptForKey() {
    return prompt('Ù†Ø§Ù… Ú©Ù„ÛŒØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:', 'data');
}

// Ø³Ø§Ø²Ù†Ø¯Ù‡ JSON ØªØ¹Ø§Ù…Ù„ÛŒ
function createJsonBuilder() {
    const modal = new bootstrap.Modal(document.createElement('div'));
    const modalHTML = `
        <div class="modal fade" id="jsonBuilderModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="bi bi-plus-circle text-primary"></i> Ø³Ø§Ø®Øª JSON
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Ú©Ù„ÛŒØ¯ (Key)</label>
                                <input type="text" class="form-control" id="json-key" placeholder="Ù…Ø«Ø§Ù„: name">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Ù…Ù‚Ø¯Ø§Ø± (Value)</label>
                                <input type="text" class="form-control" id="json-value" placeholder="Ù…Ø«Ø§Ù„: Ø¹Ù„ÛŒ">
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <button class="btn btn-outline-secondary btn-sm" id="add-pair">
                                <i class="bi bi-plus"></i> Ø§ÙØ²ÙˆØ¯Ù† Ø¬ÙØª Ú©Ù„ÛŒØ¯-Ù…Ù‚Ø¯Ø§Ø±
                            </button>
                        </div>
                        
                        <div id="json-pairs-container">
                            <!-- Ø¬ÙØªâ€ŒÙ‡Ø§ÛŒ Ø§Ø¶Ø§ÙÛŒ Ø§ÛŒÙ†Ø¬Ø§ Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
                        </div>
                        
                        <div class="mt-3">
                            <label class="form-label fw-bold">Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ JSON:</label>
                            <pre id="json-preview" class="bg-light p-3 rounded border" style="max-height: 200px; overflow-y: auto;">
{
  "key": "value"
}
                            </pre>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ù„ØºÙˆ</button>
                        <button type="button" class="btn btn-primary" id="apply-json">
                            <i class="bi bi-check"></i> Ø§Ø¹Ù…Ø§Ù„ JSON
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Ø­Ø°Ù modal Ù‚Ø¨Ù„ÛŒ Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯
    const existingModal = document.getElementById('jsonBuilderModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    const modalElement = document.getElementById('jsonBuilderModal');
    const jsonModal = new bootstrap.Modal(modalElement);
    
    // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´
    function updatePreview() {
        const mainKey = document.getElementById('json-key').value.trim() || 'key';
        const mainValue = document.getElementById('json-value').value.trim() || 'value';
        const result = {};
        
        result[mainKey] = mainValue;
        
        // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¬ÙØªâ€ŒÙ‡Ø§ÛŒ Ø§Ø¶Ø§ÙÛŒ
        const additionalPairs = document.querySelectorAll('.additional-pair');
        additionalPairs.forEach(pair => {
            const key = pair.querySelector('.pair-key').value.trim();
            const value = pair.querySelector('.pair-value').value.trim();
            if (key && value) {
                result[key] = value;
            }
        });
        
        document.getElementById('json-preview').textContent = JSON.stringify(result, null, 2);
    }
    
    // Event listeners
    document.getElementById('json-key').addEventListener('input', updatePreview);
    document.getElementById('json-value').addEventListener('input', updatePreview);
    
    document.getElementById('add-pair').addEventListener('click', function() {
        const container = document.getElementById('json-pairs-container');
        const pairHTML = `
            <div class="row mb-2 additional-pair">
                <div class="col-md-5">
                    <input type="text" class="form-control pair-key" placeholder="Ú©Ù„ÛŒØ¯">
                </div>
                <div class="col-md-5">
                    <input type="text" class="form-control pair-value" placeholder="Ù…Ù‚Ø¯Ø§Ø±">
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-outline-danger btn-sm remove-pair w-100">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', pairHTML);
        
        // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† event listeners Ø¨Ù‡ Ø¬ÙØª Ø¬Ø¯ÛŒØ¯
        const newPair = container.lastElementChild;
        newPair.querySelector('.pair-key').addEventListener('input', updatePreview);
        newPair.querySelector('.pair-value').addEventListener('input', updatePreview);
        newPair.querySelector('.remove-pair').addEventListener('click', function() {
            this.closest('.additional-pair').remove();
            updatePreview();
        });
    });
    
    document.getElementById('apply-json').addEventListener('click', function() {
        const jsonContent = document.getElementById('json-preview').textContent;
        document.getElementById('body-raw').value = jsonContent;
        updateCharCount();
        jsonModal.hide();
        showAlert('JSON Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¹Ù…Ø§Ù„ Ø´Ø¯!', 'success');
    });
    
    // Ø­Ø°Ù modal Ù¾Ø³ Ø§Ø² Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù†
    modalElement.addEventListener('hidden.bs.modal', function() {
        this.remove();
    });
    
    jsonModal.show();
    updatePreview();
}

// ØªØ§Ø¨Ø¹ Ù‡ÙˆØ´Ù…Ù†Ø¯ ØªØµØ­ÛŒØ­ JSON
function smartJsonFixer(content) {
    // Ø­Ø°Ù Ú©Ø§Ù…Ø§ Ø§Ø¶Ø§ÙÛŒ
    content = content.replace(/,(\s*[}\]])/g, '$1');
    
    // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ú¯ÛŒÙˆÙ…Ù‡ Ø¨Ø±Ø§ÛŒ Ú©Ù„ÛŒØ¯Ù‡Ø§
    content = content.replace(/([{,]\s*)([a-zA-Z_][a-zA-Z0-9_]*)\s*:/g, '$1"$2":');
    
    // ØªØµØ­ÛŒØ­ Ú¯ÛŒÙˆÙ…Ù‡â€ŒÙ‡Ø§ÛŒ ØªÚ©
    content = content.replace(/'/g, '"');
    
    // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¨Ø±Ø§Ú©Øª ÛŒØ§ Ø¨Ø±ÛŒØ³ Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø²
    if (content.startsWith('[') && !content.endsWith(']')) {
        content += ']';
    } else if (content.startsWith('{') && !content.endsWith('}')) {
        content += '}';
    }
    
    return JSON.parse(content);
}

// ØªØ¨Ø¯ÛŒÙ„ Query String Ø¨Ù‡ JSON
function parseQueryStringToJson(content) {
    const result = {};
    const lines = content.split(/[&\n]/);
    
    lines.forEach(line => {
        const trimmed = line.trim();
        if (trimmed && trimmed.includes('=')) {
            const [key, ...valueParts] = trimmed.split('=');
            const value = valueParts.join('=');
            result[key.trim()] = decodeURIComponent(value || '');
        }
    });
    
    return result;
}

// ØªØ¨Ø¯ÛŒÙ„ ÙÙ‡Ø±Ø³Øª Ø¨Ù‡ JSON
function parseListToJson(content) {
    const lines = content.split(/[\n,]/).map(line => line.trim()).filter(line => line);
    
    if (lines.length === 1) {
        return { "value": lines[0], "type": "single_item" };
    }
    
    // ØªØ´Ø®ÛŒØµ Ù†ÙˆØ¹ ÙÙ‡Ø±Ø³Øª
    const result = {
        "type": "list",
        "count": lines.length,
        "items": lines
    };
    
    // Ø§Ú¯Ø± Ù‡Ù…Ù‡ Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ Ø¹Ø¯Ø¯ Ù‡Ø³ØªÙ†Ø¯
    if (lines.every(item => !isNaN(item) && item !== '')) {
        result.items = lines.map(item => parseFloat(item));
        result.data_type = "numeric";
    } else {
        result.data_type = "mixed";
    }
    
    return result;
}

// Ø§ÙØ²ÙˆØ¯Ù†/Ø­Ø°Ù Ù¾Ø§Ø±Ø§Ù…ØªØ±
document.getElementById('add-param').addEventListener('click', function() {
    const container = document.getElementById('params-container');
    const newRow = document.querySelector('.param-row').cloneNode(true);
    newRow.querySelectorAll('input').forEach(input => input.value = '');
    container.appendChild(newRow);
});

document.addEventListener('click', function(e) {
    if (e.target.closest('.remove-param')) {
        const paramRows = document.querySelectorAll('.param-row');
        if (paramRows.length > 1) {
            e.target.closest('.param-row').remove();
            updateUrlPreview();
        }
    }
});

// Ø§ÙØ²ÙˆØ¯Ù†/Ø­Ø°Ù Ù‡Ø¯Ø±
document.getElementById('add-header').addEventListener('click', function() {
    const container = document.getElementById('headers-container');
    const newRow = document.querySelector('.header-row').cloneNode(true);
    newRow.querySelectorAll('input').forEach(input => input.value = '');
    container.appendChild(newRow);
});

document.addEventListener('click', function(e) {
    if (e.target.closest('.remove-header')) {
        const headerRows = document.querySelectorAll('.header-row');
        if (headerRows.length > 1) {
            e.target.closest('.header-row').remove();
        }
    }
});

// Ø§ÙØ²ÙˆØ¯Ù† Ù‡Ø¯Ø± Ø±Ø§ÛŒØ¬
document.addEventListener('click', function(e) {
    if (e.target.closest('.common-header')) {
        e.preventDefault();
        const key = e.target.closest('.common-header').dataset.key;
        const value = e.target.closest('.common-header').dataset.value;
        
        // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø§ÙˆÙ„ÛŒÙ† Ø±Ø¯ÛŒÙ Ø®Ø§Ù„ÛŒ ÛŒØ§ Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø±Ø¯ÛŒÙ Ø¬Ø¯ÛŒØ¯
        const headerRows = document.querySelectorAll('.header-row');
        let emptyRow = null;
        
        for (let row of headerRows) {
            const keyInput = row.querySelector('.header-key');
            const valueInput = row.querySelector('.header-value');
            if (!keyInput.value.trim() && !valueInput.value.trim()) {
                emptyRow = row;
                break;
            }
        }
        
        if (!emptyRow) {
            document.getElementById('add-header').click();
            emptyRow = document.querySelector('.header-row:last-child');
        }
        
        emptyRow.querySelector('.header-key').value = key;
        emptyRow.querySelector('.header-value').value = value;
        emptyRow.querySelector('.header-enabled').checked = true;
    }
});

// Ù…Ø¯ÛŒØ±ÛŒØª Form Data
document.addEventListener('change', function(e) {
    if (e.target.classList.contains('form-data-type')) {
        const row = e.target.closest('.form-data-row');
        const textInput = row.querySelector('.form-data-value');
        const fileInput = row.querySelector('.form-data-file');
        
        if (e.target.value === 'file') {
            textInput.style.display = 'none';
            fileInput.style.display = 'block';
        } else {
            textInput.style.display = 'block';
            fileInput.style.display = 'none';
        }
    }
});

document.getElementById('add-form-data').addEventListener('click', function() {
    const container = document.getElementById('form-data-container');
    const newRow = document.querySelector('.form-data-row').cloneNode(true);
    newRow.querySelectorAll('input').forEach(input => {
        if (input.type !== 'checkbox') {
            input.value = '';
        } else {
            input.checked = true;
        }
    });
    newRow.querySelector('.form-data-type').value = 'text';
    newRow.querySelector('.form-data-value').style.display = 'block';
    newRow.querySelector('.form-data-file').style.display = 'none';
    container.appendChild(newRow);
});

document.addEventListener('click', function(e) {
    if (e.target.closest('.remove-form-data')) {
        const formDataRows = document.querySelectorAll('.form-data-row');
        if (formDataRows.length > 1) {
            e.target.closest('.form-data-row').remove();
        }
    }
});

// Ù…Ø¯ÛŒØ±ÛŒØª URL Encoded
document.getElementById('add-urlencoded').addEventListener('click', function() {
    const container = document.getElementById('urlencoded-container');
    const newRow = document.querySelector('.urlencoded-row').cloneNode(true);
    newRow.querySelectorAll('input').forEach(input => {
        if (input.type !== 'checkbox') {
            input.value = '';
        } else {
            input.checked = true;
        }
    });
    container.appendChild(newRow);
});

document.addEventListener('click', function(e) {
    if (e.target.closest('.remove-urlencoded')) {
        const urlencodedRows = document.querySelectorAll('.urlencoded-row');
        if (urlencodedRows.length > 1) {
            e.target.closest('.urlencoded-row').remove();
        }
    }
});

// Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ URL Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´
function updateUrlPreview() {
    const baseUrl = document.getElementById('url').value.trim();
    const finalUrlElement = document.getElementById('final-url');
    
    if (!baseUrl) {
        finalUrlElement.textContent = 'URL Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯...';
        return;
    }
    
    // Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ÛŒ ÙØ¹Ø§Ù„
    const params = [];
    document.querySelectorAll('.param-row').forEach(row => {
        const key = row.querySelector('.param-key').value.trim();
        const value = row.querySelector('.param-value').value.trim();
        const enabled = row.querySelector('.param-enabled').checked;
        if (key && value && enabled) {
            params.push(`${encodeURIComponent(key)}=${encodeURIComponent(value)}`);
        }
    });
    
    let finalUrl = baseUrl;
    if (params.length > 0) {
        const separator = baseUrl.includes('?') ? '&' : '?';
        finalUrl += separator + params.join('&');
    }
    
    finalUrlElement.textContent = finalUrl;
}

// Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù† URL
document.getElementById('copy-url').addEventListener('click', function() {
    const finalUrl = document.getElementById('final-url').textContent;
    if (finalUrl && finalUrl !== 'URL Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯...') {
        navigator.clipboard.writeText(finalUrl).then(() => {
            showAlert('URL Ú©Ù¾ÛŒ Ø´Ø¯!', 'success');
        }).catch(() => {
            showAlert('Ø®Ø·Ø§ Ø¯Ø± Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù† URL', 'danger');
        });
    }
});

// Event listeners Ø¨Ø±Ø§ÛŒ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ URL
document.getElementById('url').addEventListener('input', updateUrlPreview);
document.addEventListener('input', function(e) {
    if (e.target.classList.contains('param-key') || e.target.classList.contains('param-value')) {
        updateUrlPreview();
    }
});
document.addEventListener('change', function(e) {
    if (e.target.classList.contains('param-enabled')) {
        updateUrlPreview();
    }
});

// Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø³Ø±ÛŒØ¹
document.getElementById('quick-request-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const sendBtn = document.getElementById('send-btn');
    const originalText = sendBtn.innerHTML;
    sendBtn.innerHTML = '<div class="loading-spinner"></div> Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„...';
    sendBtn.disabled = true;
    
    try {
        // Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
        const params = {};
        document.querySelectorAll('.param-row').forEach(row => {
            const key = row.querySelector('.param-key').value.trim();
            const value = row.querySelector('.param-value').value.trim();
            const enabled = row.querySelector('.param-enabled').checked;
            if (key && value && enabled) {
                params[key] = value;
            }
        });
        
        const headers = {};
        document.querySelectorAll('.header-row').forEach(row => {
            const key = row.querySelector('.header-key').value.trim();
            const value = row.querySelector('.header-value').value.trim();
            const enabled = row.querySelector('.header-enabled').checked;
            if (key && value && enabled) {
                headers[key] = value;
            }
        });
        
        const bodyType = document.getElementById('body-type').value;
        let bodyData = '';
        let formData = {};
        let urlencodedData = {};
        
        if (bodyType === 'raw') {
            bodyData = document.getElementById('body-raw')?.value || '';
        } else if (bodyType === 'form-data') {
            document.querySelectorAll('.form-data-row').forEach(row => {
                const key = row.querySelector('.form-data-key').value.trim();
                const enabled = row.querySelector('.form-data-enabled').checked;
                const type = row.querySelector('.form-data-type').value;
                
                if (key && enabled) {
                    if (type === 'text') {
                        const value = row.querySelector('.form-data-value').value.trim();
                        if (value) formData[key] = value;
                    } else if (type === 'file') {
                        const fileInput = row.querySelector('.form-data-file');
                        if (fileInput.files.length > 0) {
                            formData[key] = fileInput.files[0].name;
                        }
                    }
                }
            });
        } else if (bodyType === 'x-www-form-urlencoded') {
            document.querySelectorAll('.urlencoded-row').forEach(row => {
                const key = row.querySelector('.urlencoded-key').value.trim();
                const value = row.querySelector('.urlencoded-value').value.trim();
                const enabled = row.querySelector('.urlencoded-enabled').checked;
                if (key && value && enabled) {
                    urlencodedData[key] = value;
                }
            });
        }
        
        const requestData = {
            method: document.getElementById('method').value,
            url: document.getElementById('url').value,
            params: params,
            headers: headers,
            body_type: bodyType,
            body_raw: bodyData,
            body_form_data: formData,
            body_urlencoded: urlencodedData
        };
        
        const response = await axios.post('/request/api/quick-request/', requestData);
        const result = response.data;
        currentHistoryId = result.id;
        
        // Ù†Ù…Ø§ÛŒØ´ Ù¾Ø§Ø³Ø®
        displayResponse(result);
        showAlert('Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯!', 'success');
        
        // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¢Ù…Ø§Ø±
        loadDashboardStats();
        
    } catch (error) {
        console.error('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª:', error);
        showAlert('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª: ' + (error.response?.data?.error || error.message), 'danger');
    } finally {
        sendBtn.innerHTML = originalText;
        sendBtn.disabled = false;
    }
});

// Ù†Ù…Ø§ÛŒØ´ Ù¾Ø§Ø³Ø®
function displayResponse(result) {
    document.getElementById('response-section').style.display = 'block';
    
    // ÙˆØ¶Ø¹ÛŒØª
    const statusBadge = document.getElementById('response-status');
    statusBadge.textContent = result.status_code || 'Ø®Ø·Ø§';
    statusBadge.className = `badge fs-6 ${result.is_success ? 'bg-success' : 'bg-danger'}`;
    
    // Ø²Ù…Ø§Ù† Ùˆ Ø§Ù†Ø¯Ø§Ø²Ù‡
    document.getElementById('response-time').textContent = formatResponseTime(result.response_time);
    document.getElementById('response-size').textContent = result.response_size ? 
        (result.response_size + ' Ø¨Ø§ÛŒØª') : '-';
    
    // Ø¨Ø¯Ù†Ù‡ Ù¾Ø§Ø³Ø®
    try {
        const jsonData = JSON.parse(result.response_body);
        document.getElementById('response-body-content').textContent = 
            JSON.stringify(jsonData, null, 2);
    } catch (e) {
        document.getElementById('response-body-content').textContent = result.response_body;
    }
    
    // Ù‡Ø¯Ø±Ù‡Ø§ÛŒ Ù¾Ø§Ø³Ø®
    document.getElementById('response-headers-content').textContent = 
        JSON.stringify(result.response_headers, null, 2);
    
    // Ø§Ø³Ú©Ø±ÙˆÙ„ Ø¨Ù‡ Ù¾Ø§Ø³Ø®
    document.getElementById('response-section').scrollIntoView({ behavior: 'smooth' });
}

// Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
document.addEventListener('DOMContentLoaded', function() {
    loadDashboardStats();
});
</script>
{% endblock %}