{% extends 'base.html' %}

{% block title %}Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ - Iran Postman{% endblock %}

{% block extra_css %}
<style>
    .compact-layout {
        max-height: 90vh;
        overflow-y: auto;
    }
    
    .quick-request-section {
        position: sticky;
        top: 0;
        z-index: 100;
        background: white;
        border-radius: 15px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        padding: 20px;
    }
    
    .response-section {
        background: white;
        border-radius: 15px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        padding: 20px;
        border-right: 4px solid #28a745;
    }
    
    .response-section.error {
        border-right-color: #dc3545;
    }
    
    .response-header {
        display: flex;
        justify-content: between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #dee2e6;
    }
    
    .response-stats {
        display: flex;
        gap: 20px;
        margin-bottom: 15px;
    }
    
    .response-stat {
        text-align: center;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 8px;
        flex: 1;
    }
    
    .response-content {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        max-height: 300px;
        overflow-y: auto;
        font-family: 'Courier New', monospace;
        font-size: 14px;
        white-space: pre-wrap;
    }
    
    .response-tabs {
        margin-bottom: 15px;
    }
    
    .response-tabs .nav-link {
        border-radius: 8px;
        margin-left: 5px;
        padding: 8px 15px;
    }
</style>
{% endblock %}

{% block content %}
<div class="compact-layout">
    <!-- Ø³Ø§Ø²Ù†Ø¯Ù‡ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø³Ø±ÛŒØ¹ -->
    <div class="quick-request-section">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="fw-bold mb-0">
                <i class="bi bi-play-circle text-primary"></i> Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø³Ø±ÛŒØ¹
            </h4>
            <span class="badge bg-primary">ÙÙˆØ±ÛŒ</span>
        </div>
        
        <form id="quick-request-form">
            {% csrf_token %}
            
            <!-- URL Ùˆ Method -->
            <div class="row mb-3">
                <div class="col-md-2">
                    <select class="form-select" id="method" name="method">
                        <option value="GET">GET</option>
                        <option value="POST">POST</option>
                        <option value="PUT">PUT</option>
                        <option value="PATCH">PATCH</option>
                        <option value="DELETE">DELETE</option>
                    </select>
                </div>
                <div class="col-md-8">
                    <input type="url" class="form-control" id="url" name="url" 
                           placeholder="https://jsonplaceholder.typicode.com/posts/1" required>
                    <div class="form-text">
                        <small class="text-muted">
                            ğŸ’¡ Ù…Ø«Ø§Ù„: https://jsonplaceholder.typicode.com/posts/1 (Ø¨Ø±Ø§ÛŒ ØªØ³Øª)<br>
                            ğŸ”¹ <strong>ØªØ³Øª Ø³Ø±ÙˆØ±:</strong> Ø¨Ø±Ø±Ø³ÛŒ Ø§ØªØµØ§Ù„ Ø¨Ø§ Ø³Ø±ÙˆØ± Iran Postman<br>
                            ğŸ”¹ <strong>Ù¾Ø± Ú©Ø±Ø¯Ù† Ø³Ø±ÛŒØ¹:</strong> ÙˆØ§Ø±Ø¯ Ú©Ø±Ø¯Ù† URL Ù†Ù…ÙˆÙ†Ù‡ Ø¨Ø±Ø§ÛŒ ØªØ³Øª Ø³Ø±ÛŒØ¹
                        </small>
                    </div>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100" id="send-btn">
                        <i class="bi bi-send"></i> Ø§Ø±Ø³Ø§Ù„
                    </button>
                    <button type="button" class="btn btn-outline-info w-100 mt-1" id="test-btn">
                        <i class="bi bi-wifi"></i> ØªØ³Øª Ø³Ø±ÙˆØ±
                    </button>
                    <button type="button" class="btn btn-outline-secondary w-100 mt-1" id="quick-fill-btn">
                        <i class="bi bi-lightning"></i> Ù¾Ø± Ú©Ø±Ø¯Ù† Ø³Ø±ÛŒØ¹
                    </button>
                    <button type="button" class="btn btn-outline-warning w-100 mt-1" id="test-nav-btn">
                        <i class="bi bi-bug"></i> ØªØ³Øª Navigation
                    </button>
                </div>
            </div>
            
            <!-- Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ URL Ù†Ù‡Ø§ÛŒÛŒ -->
            <div class="url-preview-section" style="display: none;">
                <div class="alert alert-info">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong><i class="bi bi-link-45deg"></i> URL Ù†Ù‡Ø§ÛŒÛŒ:</strong>
                            <span id="final-url-display">URL Ø±Ø§ ØªÚ©Ù…ÛŒÙ„ Ú©Ù†ÛŒØ¯...</span>
                        </div>
                        <button type="button" class="btn btn-outline-primary btn-sm" id="copy-final-url">
                            <i class="bi bi-clipboard"></i> Ú©Ù¾ÛŒ
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- ØªØ¨â€ŒÙ‡Ø§ÛŒ ÙØ´Ø±Ø¯Ù‡ -->
            <ul class="nav nav-pills nav-fill mb-3" id="requestTabs">
                <li class="nav-item">
                    <button class="nav-link active" type="button" data-bs-toggle="tab" data-bs-target="#params-tab">Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" type="button" data-bs-toggle="tab" data-bs-target="#headers-tab">Ù‡Ø¯Ø±Ù‡Ø§</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" type="button" data-bs-toggle="tab" data-bs-target="#body-tab">Ø¨Ø¯Ù†Ù‡</button>
                </li>
            </ul>

            <div class="tab-content">
                <!-- Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ -->
                <div class="tab-pane fade show active" id="params-tab">
                    <div id="params-container">
                        <div class="row mb-2 param-row">
                            <div class="col-md-5">
                                <input type="text" class="form-control param-key" placeholder="Ú©Ù„ÛŒØ¯">
                            </div>
                            <div class="col-md-6">
                                <input type="text" class="form-control param-value" placeholder="Ù…Ù‚Ø¯Ø§Ø±">
                            </div>
                            <div class="col-md-1">
                                <input class="form-check-input param-enabled" type="checkbox" checked>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-outline-primary btn-sm" id="add-param">
                        <i class="bi bi-plus"></i> Ø§ÙØ²ÙˆØ¯Ù†
                    </button>
                </div>

                <!-- Ù‡Ø¯Ø±Ù‡Ø§ -->
                <div class="tab-pane fade" id="headers-tab">
                    <div id="headers-container">
                        <div class="row mb-2 header-row">
                            <div class="col-md-5">
                                <input type="text" class="form-control header-key" placeholder="Ú©Ù„ÛŒØ¯ Ù‡Ø¯Ø±">
                            </div>
                            <div class="col-md-6">
                                <input type="text" class="form-control header-value" placeholder="Ù…Ù‚Ø¯Ø§Ø±">
                            </div>
                            <div class="col-md-1">
                                <input class="form-check-input header-enabled" type="checkbox" checked>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-outline-primary btn-sm" id="add-header">
                        <i class="bi bi-plus"></i> Ø§ÙØ²ÙˆØ¯Ù†
                    </button>
                </div>

                <!-- Ø¨Ø¯Ù†Ù‡ -->
                <div class="tab-pane fade" id="body-tab">
                    <select class="form-select mb-2" id="body-type">
                        <option value="none">Ù‡ÛŒÚ†</option>
                        <option value="raw">Raw</option>
                        <option value="form-data">Form Data</option>
                        <option value="x-www-form-urlencoded">URL Encoded</option>
                    </select>
                    
                    <div id="body-none-section">
                        <div class="text-center p-4 text-muted">
                            <i class="bi bi-info-circle h4 mb-2"></i>
                            <p>Ù‡ÛŒÚ† Ù…Ø­ØªÙˆØ§ÛŒÛŒ Ø§Ø±Ø³Ø§Ù„ Ù†Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯</p>
                        </div>
                    </div>
                    
                    <div id="body-raw-section" style="display: none;">
                        <textarea class="form-control font-monospace" id="body-raw" rows="4" 
                                  placeholder="Ù…Ø­ØªÙˆØ§ÛŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯..."></textarea>
                        <div class="mt-2">
                            <button type="button" class="btn btn-outline-success btn-sm" id="fix-json">
                                <i class="bi bi-tools"></i> ØªØµØ­ÛŒØ­ JSON
                            </button>
                            <button type="button" class="btn btn-outline-primary btn-sm" id="create-json">
                                <i class="bi bi-plus-circle"></i> Ø³Ø§Ø®Øª JSON
                            </button>
                        </div>
                    </div>
                    
                    <div id="body-form-data-section" style="display: none;">
                        <h6 class="fw-bold mb-3">Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ÙØ±Ù…</h6>
                        <div id="form-data-container">
                            <div class="row mb-2 form-data-row">
                                <div class="col-md-4">
                                    <input type="text" class="form-control form-data-key" placeholder="Ù†Ø§Ù… ÙÛŒÙ„Ø¯">
                                </div>
                                <div class="col-md-2">
                                    <select class="form-select form-data-type">
                                        <option value="text">Text</option>
                                        <option value="file">File</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <input type="text" class="form-control form-data-value" placeholder="Ù…Ù‚Ø¯Ø§Ø±">
                                    <input type="file" class="form-control form-data-file" style="display: none;">
                                </div>
                                <div class="col-md-1">
                                    <input class="form-check-input form-data-enabled" type="checkbox" checked>
                                </div>
                                <div class="col-md-1">
                                    <button type="button" class="btn btn-outline-danger btn-sm remove-form-data">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-outline-primary btn-sm" id="add-form-data">
                            <i class="bi bi-plus"></i> Ø§ÙØ²ÙˆØ¯Ù† ÙÛŒÙ„Ø¯
                        </button>
                    </div>
                    
                    <div id="body-urlencoded-section" style="display: none;">
                        <h6 class="fw-bold mb-3">Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ URL Encoded</h6>
                        <div id="urlencoded-container">
                            <div class="row mb-2 urlencoded-row">
                                <div class="col-md-5">
                                    <input type="text" class="form-control urlencoded-key" placeholder="Ù†Ø§Ù… Ù¾Ø§Ø±Ø§Ù…ØªØ±">
                                </div>
                                <div class="col-md-5">
                                    <input type="text" class="form-control urlencoded-value" placeholder="Ù…Ù‚Ø¯Ø§Ø±">
                                </div>
                                <div class="col-md-1">
                                    <input class="form-check-input urlencoded-enabled" type="checkbox" checked>
                                </div>
                                <div class="col-md-1">
                                    <button type="button" class="btn btn-outline-danger btn-sm remove-urlencoded">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-outline-primary btn-sm" id="add-urlencoded">
                            <i class="bi bi-plus"></i> Ø§ÙØ²ÙˆØ¯Ù† Ù¾Ø§Ø±Ø§Ù…ØªØ±
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <!-- Ù†Ù…Ø§ÛŒØ´ Ù¾Ø§Ø³Ø® -->
    <div id="response-section" class="response-section" style="display: none;">
        <div class="response-header">
            <h5 class="mb-0">
                <i class="bi bi-arrow-down-circle text-success"></i> Ù¾Ø§Ø³Ø® API
            </h5>
            <button class="btn btn-outline-secondary btn-sm" id="clear-response">
                <i class="bi bi-x"></i> Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†
            </button>
        </div>
        
        <div class="response-stats">
            <div class="response-stat">
                <div class="fw-bold" id="response-status">-</div>
                <small class="text-muted">Ú©Ø¯ ÙˆØ¶Ø¹ÛŒØª</small>
            </div>
            <div class="response-stat">
                <div class="fw-bold" id="response-time">-</div>
                <small class="text-muted">Ø²Ù…Ø§Ù† Ù¾Ø§Ø³Ø®</small>
            </div>
            <div class="response-stat">
                <div class="fw-bold" id="response-size">-</div>
                <small class="text-muted">Ø§Ù†Ø¯Ø§Ø²Ù‡</small>
            </div>
        </div>
        
        <ul class="nav nav-tabs response-tabs">
            <li class="nav-item">
                <button class="nav-link active" type="button" data-bs-toggle="tab" data-bs-target="#response-body">
                    <i class="bi bi-file-text"></i> Ø¨Ø¯Ù†Ù‡ Ù¾Ø§Ø³Ø®
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" type="button" data-bs-toggle="tab" data-bs-target="#response-headers">
                    <i class="bi bi-tags"></i> Ù‡Ø¯Ø±Ù‡Ø§ÛŒ Ù¾Ø§Ø³Ø®
                </button>
            </li>
        </ul>
        
        <div class="tab-content">
            <div class="tab-pane fade show active" id="response-body">
                <div class="response-content" id="response-body-content">
                    <!-- Ù…Ø­ØªÙˆØ§ÛŒ Ù¾Ø§Ø³Ø® Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ -->
                </div>
            </div>
            <div class="tab-pane fade" id="response-headers">
                <div class="response-content" id="response-headers-content">
                    <!-- Ù‡Ø¯Ø±Ù‡Ø§ÛŒ Ù¾Ø§Ø³Ø® Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ -->
                </div>
            </div>
        </div>
    </div>

    <!-- Ø¢Ù…Ø§Ø± Ùˆ ØªØ§Ø±ÛŒØ®Ú†Ù‡ -->
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-bar-chart"></i> Ø¢Ù…Ø§Ø±</h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6">
                            <h4 class="text-primary" id="total-collections">-</h4>
                            <small>Ú©Ø§Ù„Ú©Ø´Ù†â€ŒÙ‡Ø§</small>
                            {% if not user.is_authenticated %}
                                <br><small class="text-muted">Ù†ÛŒØ§Ø² Ø¨Ù‡ ÙˆØ±ÙˆØ¯</small>
                            {% endif %}
                        </div>
                        <div class="col-6">
                            <h4 class="text-success" id="total-environments">-</h4>
                            <small>Ù…Ø­ÛŒØ·â€ŒÙ‡Ø§</small>
                            {% if not user.is_authenticated %}
                                <br><small class="text-muted">Ù†ÛŒØ§Ø² Ø¨Ù‡ ÙˆØ±ÙˆØ¯</small>
                            {% endif %}
                        </div>
                    </div>
                    
                    {% if not user.is_authenticated %}
                        <div class="mt-3 text-center">
                            <hr>
                            <small class="text-muted">
                                <i class="bi bi-info-circle"></i>
                                Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø¢Ù…Ø§Ø± Ùˆ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯
                            </small>
                            <br>
                            <a href="{% url 'login' %}" class="btn btn-outline-primary btn-sm mt-2">
                                <i class="bi bi-box-arrow-in-right"></i> ÙˆØ±ÙˆØ¯
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header d-flex justify-content-between">
                    <h6 class="mb-0"><i class="bi bi-clock-history"></i> ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø§Ø®ÛŒØ±</h6>
                    {% if user.is_authenticated %}
                        <a href="{% url 'request:history' %}" 
                           class="btn btn-outline-primary btn-sm" 
                           onclick="console.log('ğŸ“Š Navigating to full history page:', this.href);">
                           Ù‡Ù…Ù‡
                        </a>
                    {% else %}
                        <span class="btn btn-outline-secondary btn-sm disabled" 
                              title="Ø¨Ø±Ø§ÛŒ Ù…Ø´Ø§Ù‡Ø¯Ù‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ú©Ø§Ù…Ù„ Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯"
                              onclick="showAlert('Ø¨Ø±Ø§ÛŒ Ù…Ø´Ø§Ù‡Ø¯Ù‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ú©Ø§Ù…Ù„ Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯', 'warning');">
                              Ù‡Ù…Ù‡ <i class="bi bi-lock-fill"></i>
                        </span>
                    {% endif %}
                </div>
                <div class="card-body">
                    <div id="recent-history" style="max-height: 200px; overflow-y: auto;">
                        <div class="text-center p-3">
                            <div class="spinner-border spinner-border-sm"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ú¯Ù„ÙˆØ¨Ø§Ù„
let currentHistoryId = null;
let isRequestInProgress = false;

// Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¢Ù…Ø§Ø±
async function loadDashboardStats() {
    try {
        const response = await axios.get('/request/api/dashboard-stats/');
        const stats = response.data;
        
        document.getElementById('total-collections').textContent = stats.total_collections;
        document.getElementById('total-environments').textContent = stats.total_environments;
        
        // ØªØ§Ø±ÛŒØ®Ú†Ù‡
        const recentHistory = document.getElementById('recent-history');
        if (stats.recent_requests.length === 0) {
            if (stats.message) {
                // Ú©Ø§Ø±Ø¨Ø± Ù„Ø§Ú¯ÛŒÙ† Ù†Ø¨Ø§Ø´Ø¯
                recentHistory.innerHTML = `
                    <div class="text-center p-3 text-muted">
                        <i class="bi bi-lock h4 mb-2"></i>
                        <p>${stats.message}</p>
                        <a href="/login/" class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-box-arrow-in-right"></i> ÙˆØ±ÙˆØ¯
                        </a>
                    </div>
                `;
            } else {
                recentHistory.innerHTML = '<p class="text-muted text-center">ØªØ§Ø±ÛŒØ®Ú†Ù‡â€ŒØ§ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</p>';
            }
        } else {
            recentHistory.innerHTML = stats.recent_requests.map(item => `
                <div class="d-flex justify-content-between border-bottom py-2">
                    <div>
                        <span class="badge ${getMethodBadgeClass(item.method)} me-1">${item.method}</span>
                        <small>${item.request_name || 'Ø³Ø±ÛŒØ¹'}</small>
                    </div>
                    <small class="text-muted">${item.status_code || 'Ø®Ø·Ø§'}</small>
                </div>
            `).join('');
        }
    } catch (error) {
        console.error('Ø®Ø·Ø§:', error);
        // Ø¯Ø± ØµÙˆØ±Øª Ø¹Ø¯Ù… Ø¯Ø³ØªØ±Ø³ÛŒØŒ Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ù…Ù†Ø§Ø³Ø¨
        document.getElementById('recent-history').innerHTML = `
            <div class="text-center p-3 text-warning">
                <i class="bi bi-exclamation-triangle h4 mb-2"></i>
                <p>Ø¹Ø¯Ù… Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¢Ù…Ø§Ø±</p>
                <small>Ù…Ù…Ú©Ù† Ø§Ø³Øª Ù†ÛŒØ§Ø² Ø¨Ù‡ ÙˆØ±ÙˆØ¯ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´ÛŒØ¯</small>
            </div>
        `;
    }
}

// Ù…Ø¯ÛŒØ±ÛŒØª ØªØ¨â€ŒÙ‡Ø§ (Ø¨Ø¯ÙˆÙ† Ø§Ø±Ø³Ø§Ù„ Ø®ÙˆØ¯Ú©Ø§Ø±)
document.getElementById('body-type').addEventListener('change', function() {
    const bodyType = this.value;
    
    // Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† Ù‡Ù…Ù‡ Ø¨Ø®Ø´â€ŒÙ‡Ø§
    document.getElementById('body-none-section').style.display = 'none';
    document.getElementById('body-raw-section').style.display = 'none';
    document.getElementById('body-form-data-section').style.display = 'none';
    document.getElementById('body-urlencoded-section').style.display = 'none';
    
    // Ù†Ù…Ø§ÛŒØ´ Ø¨Ø®Ø´ Ù…Ø±Ø¨ÙˆØ·Ù‡
    switch(bodyType) {
        case 'none':
            document.getElementById('body-none-section').style.display = 'block';
            break;
        case 'raw':
            document.getElementById('body-raw-section').style.display = 'block';
            break;
        case 'form-data':
            document.getElementById('body-form-data-section').style.display = 'block';
            break;
        case 'x-www-form-urlencoded':
            document.getElementById('body-urlencoded-section').style.display = 'block';
            break;
    }
});

// Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ URL Ù†Ù‡Ø§ÛŒÛŒ
function updateFinalUrl() {
    const baseUrl = document.getElementById('url').value.trim();
    const urlDisplay = document.getElementById('final-url-display');
    const urlSection = document.querySelector('.url-preview-section');
    
    if (!baseUrl) {
        urlSection.style.display = 'none';
        return;
    }
    
    // Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ÛŒ ÙØ¹Ø§Ù„
    const params = [];
    document.querySelectorAll('.param-row').forEach(row => {
        const key = row.querySelector('.param-key').value.trim();
        const value = row.querySelector('.param-value').value.trim();
        const enabled = row.querySelector('.param-enabled').checked;
        if (key && value && enabled) {
            params.push(`${encodeURIComponent(key)}=${encodeURIComponent(value)}`);
        }
    });
    
    let finalUrl = baseUrl;
    if (params.length > 0) {
        const separator = baseUrl.includes('?') ? '&' : '?';
        finalUrl += separator + params.join('&');
    }
    
    urlDisplay.textContent = finalUrl;
    urlSection.style.display = 'block';
}

// Event listeners Ø¨Ø±Ø§ÛŒ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ URL
document.getElementById('url').addEventListener('input', updateFinalUrl);
document.addEventListener('input', function(e) {
    if (e.target.classList.contains('param-key') || e.target.classList.contains('param-value')) {
        updateFinalUrl();
    }
});
document.addEventListener('change', function(e) {
    if (e.target.classList.contains('param-enabled')) {
        updateFinalUrl();
    }
});

// Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù† URL Ù†Ù‡Ø§ÛŒÛŒ
document.getElementById('copy-final-url').addEventListener('click', function() {
    const finalUrl = document.getElementById('final-url-display').textContent;
    if (finalUrl && finalUrl !== 'URL Ø±Ø§ ØªÚ©Ù…ÛŒÙ„ Ú©Ù†ÛŒØ¯...') {
        navigator.clipboard.writeText(finalUrl).then(() => {
            showAlert('URL Ú©Ù¾ÛŒ Ø´Ø¯!', 'success', 2000);
        }).catch(() => {
            showAlert('Ø®Ø·Ø§ Ø¯Ø± Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù† URL', 'error');
        });
    }
});

// JSON Tools - ÙÙ‚Ø· JSON Ù…Ø¹ÛŒÙˆØ¨ Ø±Ùˆ ØªØµØ­ÛŒØ­ Ú©Ù†
document.addEventListener('click', function(e) {
    // ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø®Ø§Øµ preventDefault Ú©Ù†ØŒ Ù†Ù‡ Ù‡Ù…Ù‡ Ú©Ù„ÛŒÚ©â€ŒÙ‡Ø§!
    if (e.target.closest('#fix-json') || e.target.closest('#create-json')) {
        e.preventDefault(); // Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø§Ø±Ø³Ø§Ù„ ÙØ±Ù…
    }
    
    if (e.target.closest('#fix-json')) {
        const textarea = document.getElementById('body-raw');
        let content = textarea.value.trim();
        
        if (!content) {
            showAlert('Ù…Ø­ØªÙˆØ§ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª!', 'warning');
            return;
        }
        
        // Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¢ÛŒØ§ Ù…Ø­ØªÙˆØ§ Ø´Ø¨ÛŒÙ‡ JSON Ø§Ø³Øª (Ø´Ø±ÙˆØ¹ Ø¨Ø§ { ÛŒØ§ [)
        if (content.startsWith('{') || content.startsWith('[')) {
            try {
                // ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ ØªØµØ­ÛŒØ­ JSON Ù…Ø¹ÛŒÙˆØ¨
                let fixedContent = content;
                
                // Ø­Ø°Ù Ú©Ø§Ù…Ù†Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù (Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ Ùˆ ÙØ§Ø±Ø³ÛŒ)
                fixedContent = fixedContent.replace(/\/\/.*$/gm, ''); // Ú©Ø§Ù…Ù†Øªâ€ŒÙ‡Ø§ÛŒ //
                fixedContent = fixedContent.replace(/\/\*[\s\S]*?\*\//g, ''); // Ú©Ø§Ù…Ù†Øªâ€ŒÙ‡Ø§ÛŒ /* */
                
                // Ø­Ø°Ù Ú©Ø§Ù…Ø§ Ø§Ø¶Ø§ÙÛŒ Ù‚Ø¨Ù„ Ø§Ø² } ÛŒØ§ ]
                fixedContent = fixedContent.replace(/,(\s*[}\]])/g, '$1');
                
                // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ú¯ÛŒÙˆÙ…Ù‡ Ø¨Ø±Ø§ÛŒ Ú©Ù„ÛŒØ¯Ù‡Ø§ÛŒ Ø¨Ø¯ÙˆÙ† Ú¯ÛŒÙˆÙ…Ù‡
                fixedContent = fixedContent.replace(/([{,]\s*)([a-zA-Z_][a-zA-Z0-9_]*)\s*:/g, '$1"$2":');
                
                // ØªØµØ­ÛŒØ­ Ú¯ÛŒÙˆÙ…Ù‡â€ŒÙ‡Ø§ÛŒ ØªÚ© Ø¨Ù‡ Ø¯Ø§Ø¨Ù„
                fixedContent = fixedContent.replace(/'/g, '"');
                
                // Ø­Ø°Ù ÙØ§ØµÙ„Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ø¶Ø§ÙÛŒ
                fixedContent = fixedContent.replace(/\s+/g, ' ').trim();
                
                // ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ parse Ú©Ø±Ø¯Ù†
                const parsed = JSON.parse(fixedContent);
                textarea.value = JSON.stringify(parsed, null, 2);
                showAlert('JSON Ù…Ø¹ÛŒÙˆØ¨ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªØµØ­ÛŒØ­ Ø´Ø¯!', 'success');
                
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± ØªØµØ­ÛŒØ­ JSON:', error);
                
                // Ø§Ú¯Ø± Ù‡Ù†ÙˆØ² Ù¾Ø§Ø±Ø³ Ù†Ø´Ø¯ØŒ ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ ØªØµØ­ÛŒØ­ Ø¯Ø³ØªÛŒ Ø¨ÛŒØ´ØªØ±
                try {
                    let manualFix = content;
                    
                    // Ø­Ø°Ù Ù‡Ù…Ù‡ Ù†ÙˆØ¹ Ú©Ø§Ù…Ù†Øª
                    manualFix = manualFix.replace(/\/\/[^\r\n]*/g, '');
                    manualFix = manualFix.replace(/\/\*[\s\S]*?\*\//g, '');
                    
                    // Ø­Ø°Ù Ú©Ø§Ù…Ù†Øªâ€ŒÙ‡Ø§ÛŒ Ø¯Ø± Ù¾Ø±Ø§Ù†ØªØ²
                    manualFix = manualFix.replace(/\([^)]*\)/g, '');
                    
                    // ØªØµØ­ÛŒØ­ null values
                    manualFix = manualFix.replace(/:\s*null/g, ': null');
                    
                    // Ø­Ø°Ù Ú©Ø§Ù…Ø§ Ø¢Ø®Ø±
                    manualFix = manualFix.replace(/,(\s*[}\]])/g, '$1');
                    
                    // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ú¯ÛŒÙˆÙ…Ù‡ Ø¨Ø±Ø§ÛŒ Ú©Ù„ÛŒØ¯Ù‡Ø§
                    manualFix = manualFix.replace(/([{,]\s*)([a-zA-Z_][a-zA-Z0-9_]*)\s*:/g, '$1"$2":');
                    
                    const parsed2 = JSON.parse(manualFix);
                    textarea.value = JSON.stringify(parsed2, null, 2);
                    showAlert('JSON Ø¨Ø§ ØªØµØ­ÛŒØ­ Ø¯Ø³ØªÛŒ Ø¨Ø±Ø·Ø±Ù Ø´Ø¯!', 'success');
                    
                } catch (error2) {
                    showAlert('Ø§ÛŒÙ† JSON Ø®ÛŒÙ„ÛŒ Ù…Ø¹ÛŒÙˆØ¨ Ø§Ø³Øª Ùˆ Ù‚Ø§Ø¨Ù„ ØªØµØ­ÛŒØ­ Ù†ÛŒØ³Øª. Ù„Ø·ÙØ§Ù‹ Ø¯Ø³ØªÛŒ Ø¯Ø±Ø³Øª Ú©Ù†ÛŒØ¯.', 'warning');
                    console.error('Ø®Ø·Ø§ Ø¯Ø± ØªØµØ­ÛŒØ­ Ø¯Ø³ØªÛŒ:', error2);
                }
            }
        } else {
            showAlert('Ø§ÛŒÙ† Ù…Ø­ØªÙˆØ§ JSON Ù†ÛŒØ³Øª. Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø®Øª JSON Ø§Ø² Ø¯Ú©Ù…Ù‡ "Ø³Ø§Ø®Øª JSON" Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯', 'info');
        }
    }
    
    if (e.target.closest('#create-json')) {
        createSimpleJsonBuilder();
    }
});

// Ø§ÙØ²ÙˆØ¯Ù†/Ø­Ø°Ù Ù¾Ø§Ø±Ø§Ù…ØªØ±
document.getElementById('add-param').addEventListener('click', function(e) {
    e.preventDefault();
    const container = document.getElementById('params-container');
    const newRow = container.querySelector('.param-row').cloneNode(true);
    newRow.querySelectorAll('input[type="text"]').forEach(input => input.value = '');
    newRow.querySelector('.param-enabled').checked = true;
    container.appendChild(newRow);
    updateFinalUrl();
});

document.addEventListener('click', function(e) {
    if (e.target.closest('.remove-param')) {
        const paramRows = document.querySelectorAll('.param-row');
        if (paramRows.length > 1) {
            e.target.closest('.param-row').remove();
            updateFinalUrl();
        }
    }
});

// Ø§ÙØ²ÙˆØ¯Ù†/Ø­Ø°Ù Ù‡Ø¯Ø±
document.getElementById('add-header').addEventListener('click', function(e) {
    e.preventDefault();
    const container = document.getElementById('headers-container');
    const newRow = container.querySelector('.header-row').cloneNode(true);
    newRow.querySelectorAll('input[type="text"]').forEach(input => input.value = '');
    newRow.querySelector('.header-enabled').checked = true;
    container.appendChild(newRow);
});

document.addEventListener('click', function(e) {
    if (e.target.closest('.remove-header')) {
        const headerRows = document.querySelectorAll('.header-row');
        if (headerRows.length > 1) {
            e.target.closest('.header-row').remove();
        }
    }
});

// Ù…Ø¯ÛŒØ±ÛŒØª Form Data
document.getElementById('add-form-data').addEventListener('click', function(e) {
    e.preventDefault();
    const container = document.getElementById('form-data-container');
    const newRow = container.querySelector('.form-data-row').cloneNode(true);
    newRow.querySelectorAll('input[type="text"]').forEach(input => input.value = '');
    newRow.querySelector('.form-data-enabled').checked = true;
    newRow.querySelector('.form-data-type').value = 'text';
    newRow.querySelector('.form-data-value').style.display = 'block';
    newRow.querySelector('.form-data-file').style.display = 'none';
    container.appendChild(newRow);
});

document.addEventListener('click', function(e) {
    if (e.target.closest('.remove-form-data')) {
        const formDataRows = document.querySelectorAll('.form-data-row');
        if (formDataRows.length > 1) {
            e.target.closest('.form-data-row').remove();
        }
    }
});

document.addEventListener('change', function(e) {
    if (e.target.classList.contains('form-data-type')) {
        const row = e.target.closest('.form-data-row');
        const textInput = row.querySelector('.form-data-value');
        const fileInput = row.querySelector('.form-data-file');
        
        if (e.target.value === 'file') {
            textInput.style.display = 'none';
            fileInput.style.display = 'block';
        } else {
            textInput.style.display = 'block';
            fileInput.style.display = 'none';
        }
    }
});

// Ù…Ø¯ÛŒØ±ÛŒØª URL Encoded
document.getElementById('add-urlencoded').addEventListener('click', function(e) {
    e.preventDefault();
    const container = document.getElementById('urlencoded-container');
    const newRow = container.querySelector('.urlencoded-row').cloneNode(true);
    newRow.querySelectorAll('input[type="text"]').forEach(input => input.value = '');
    newRow.querySelector('.urlencoded-enabled').checked = true;
    container.appendChild(newRow);
});

document.addEventListener('click', function(e) {
    if (e.target.closest('.remove-urlencoded')) {
        const urlencodedRows = document.querySelectorAll('.urlencoded-row');
        if (urlencodedRows.length > 1) {
            e.target.closest('.urlencoded-row').remove();
        }
    }
});

// Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸš€ ØµÙØ­Ù‡ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯');
    console.log('ğŸ‘¤ User:', '{{ user.username|default:"Guest" }}');
    console.log('ğŸ” CSRF Token check:', document.querySelector('[name=csrfmiddlewaretoken]') ? 'Ù…ÙˆØ¬ÙˆØ¯' : 'Ù†Ø§Ù…ÙˆØ¬ÙˆØ¯');
    console.log('ğŸ“¡ Axios available:', typeof axios !== 'undefined');
    console.log('ğŸŒ Base URL:', window.location.origin);
    
    // ØªØ³Øª Ø§ÙˆÙ„ÛŒÙ‡ Ø¢Ø¯Ø±Ø³â€ŒÙ‡Ø§
    console.log('ğŸ”— Testing API endpoints:');
    console.log('   - Dashboard Stats:', '/request/api/dashboard-stats/');
    console.log('   - Quick Request:', '/request/api/quick-request/');
    
    // Ø¨Ø±Ø±Ø³ÛŒ element Ù‡Ø§ÛŒ Ù…Ù‡Ù…
    const form = document.getElementById('quick-request-form');
    const sendBtn = document.getElementById('send-btn');
    const urlInput = document.getElementById('url');
    
    console.log('ğŸ“‹ Form elements check:');
    console.log('   - Form:', form ? 'Ù…ÙˆØ¬ÙˆØ¯' : 'âŒ Ù†Ø§Ù…ÙˆØ¬ÙˆØ¯');
    console.log('   - Send Button:', sendBtn ? 'Ù…ÙˆØ¬ÙˆØ¯' : 'âŒ Ù†Ø§Ù…ÙˆØ¬ÙˆØ¯');
    console.log('   - URL Input:', urlInput ? 'Ù…ÙˆØ¬ÙˆØ¯' : 'âŒ Ù†Ø§Ù…ÙˆØ¬ÙˆØ¯');
    
    // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† event listener Ø§Ø¶Ø§ÙÛŒ Ø¨Ø±Ø§ÛŒ Ù…Ø·Ù…Ø¦Ù† Ø´Ø¯Ù†
    if (form && sendBtn) {
        console.log('âœ… Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† event listeners...');
        
        // Event listener Ø§Ø¶Ø§ÙÛŒ Ø¨Ø±Ø§ÛŒ Ø¯Ú©Ù…Ù‡
        sendBtn.addEventListener('click', function(e) {
            console.log('ğŸ–±ï¸ Ø¯Ú©Ù…Ù‡ Ø§Ø±Ø³Ø§Ù„ Ú©Ù„ÛŒÚ© Ø´Ø¯ (Ù…Ø³ØªÙ‚ÛŒÙ…)');
            e.preventDefault();
            
            // ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ ØªØ§Ø¨Ø¹ Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ ØµÙˆØ±Øª Ù…Ø³ØªÙ‚ÛŒÙ…
            handleFormSubmission();
        });
        
        // Event listener Ø¨Ø±Ø§ÛŒ ÙØ±Ù…
        form.addEventListener('submit', function(e) {
            console.log('ğŸ“‹ ÙØ±Ù… submit Ø´Ø¯');
            e.preventDefault();
            handleFormSubmission();
        });
    } else {
        console.error('âŒ Ø¹Ù†Ø§ØµØ± ÙØ±Ù… ÛŒØ§ÙØª Ù†Ø´Ø¯Ù†Ø¯!');
    }
    
    loadDashboardStats();
    // Ù†Ù…Ø§ÛŒØ´ Ø¨Ø®Ø´ none Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ù¾ÛŒØ´â€ŒÙØ±Ø¶
    document.getElementById('body-none-section').style.display = 'block';
});

// ØªØ§Ø¨Ø¹ Ù…Ø³ØªÙ‚Ù„ Ø¨Ø±Ø§ÛŒ Ú©Ù†ØªØ±Ù„ Ø§Ø±Ø³Ø§Ù„ ÙØ±Ù…
async function handleFormSubmission() {
    console.log('âš¡ Ø´Ø±ÙˆØ¹ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¯Ø±Ø®ÙˆØ§Ø³Øª...');
    
    if (isRequestInProgress) {
        console.log('â³ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù‚Ø¨Ù„ÛŒ Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø§Ø³Øª');
        showAlert('Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù‚Ø¨Ù„ÛŒ Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø§Ø³Øª', 'warning');
        return;
    }
    
    const sendBtn = document.getElementById('send-btn');
    const urlInput = document.getElementById('url');
    
    if (!sendBtn || !urlInput) {
        console.error('âŒ Ø¹Ù†Ø§ØµØ± ÙØ±Ù… ÛŒØ§ÙØª Ù†Ø´Ø¯Ù†Ø¯');
        showAlert('Ø®Ø·Ø§ Ø¯Ø± ÛŒØ§ÙØªÙ† Ø¹Ù†Ø§ØµØ± ÙØ±Ù…', 'error');
        return;
    }
    
    const url = urlInput.value.trim();
    console.log('ğŸŒ URL:', url);
    
    if (!url) {
        console.log('âŒ URL Ø®Ø§Ù„ÛŒ Ø§Ø³Øª');
        showAlert('Ù„Ø·ÙØ§Ù‹ URL Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', 'warning');
        urlInput.focus();
        return;
    }
    
    // Ø¨Ø±Ø±Ø³ÛŒ ÙØ±Ù…Øª URL
    try {
        new URL(url);
        console.log('âœ… URL Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª');
    } catch (e) {
        console.log('âŒ URL Ù†Ø§Ù…Ø¹ØªØ¨Ø±:', e.message);
        showAlert('Ù„Ø·ÙØ§Ù‹ ÛŒÚ© URL Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ù…Ø«Ø§Ù„: https://google.com)', 'warning');
        urlInput.focus();
        return;
    }
    
    const originalText = sendBtn.innerHTML;
    
    console.log('ğŸ”„ Ø´Ø±ÙˆØ¹ Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª...');
    isRequestInProgress = true;
    sendBtn.disabled = true;
    sendBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„...';
    
    try {
        // Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
        console.log('ğŸ“Š Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ÙØ±Ù…...');
        
        const params = {};
        document.querySelectorAll('.param-row').forEach((row, index) => {
            const key = row.querySelector('.param-key')?.value?.trim();
            const value = row.querySelector('.param-value')?.value?.trim();
            const enabled = row.querySelector('.param-enabled')?.checked;
            console.log(`   Param ${index}: ${key}=${value} (${enabled ? 'ÙØ¹Ø§Ù„' : 'ØºÛŒØ±ÙØ¹Ø§Ù„'})`);
            if (key && value && enabled) params[key] = value;
        });
        
        const headers = {};
        document.querySelectorAll('.header-row').forEach((row, index) => {
            const key = row.querySelector('.header-key')?.value?.trim();
            const value = row.querySelector('.header-value')?.value?.trim();
            const enabled = row.querySelector('.header-enabled')?.checked;
            console.log(`   Header ${index}: ${key}=${value} (${enabled ? 'ÙØ¹Ø§Ù„' : 'ØºÛŒØ±ÙØ¹Ø§Ù„'})`);
            if (key && value && enabled) headers[key] = value;
        });
        
        const method = document.getElementById('method')?.value || 'GET';
        const bodyType = document.getElementById('body-type')?.value || 'none';
        
        console.log('ğŸ“‹ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ù„ÛŒ:');
        console.log('   Method:', method);
        console.log('   Body Type:', bodyType);
        console.log('   Params:', params);
        console.log('   Headers:', headers);
        
        let bodyData = '';
        let formData = {};
        let urlencodedData = {};
        
        if (bodyType === 'raw') {
            bodyData = document.getElementById('body-raw')?.value || '';
            console.log('   Raw Body:', bodyData.substring(0, 100) + (bodyData.length > 100 ? '...' : ''));
        }
        
        const requestData = {
            method: method,
            url: url,
            params: params,
            headers: headers,
            body_type: bodyType,
            body_raw: bodyData,
            body_form_data: formData,
            body_urlencoded: urlencodedData
        };
        
        console.log('ğŸ“¤ Ø§Ø±Ø³Ø§Ù„ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ù‡ Ø³Ø±ÙˆØ±:', requestData);
        
        // Ø¯Ø±ÛŒØ§ÙØª CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
        console.log('ğŸ” CSRF Token:', csrfToken ? 'Ù…ÙˆØ¬ÙˆØ¯ âœ…' : 'Ù†Ø§Ù…ÙˆØ¬ÙˆØ¯ âŒ');
        
        const requestConfig = {
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken || ''
            },
            timeout: 30000
        };
        
        console.log('â° Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ù‡ /request/api/quick-request/...');
        const startTime = Date.now();
        
        const response = await axios.post('/request/api/quick-request/', requestData, requestConfig);
        
        const endTime = Date.now();
        const responseTime = endTime - startTime;
        
        console.log('âœ… Ù¾Ø§Ø³Ø® Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯ Ø¯Ø±', responseTime, 'Ù…ÛŒÙ„ÛŒâ€ŒØ«Ø§Ù†ÛŒÙ‡');
        console.log('ğŸ“¨ Response:', response.data);
        
        // Ù†Ù…Ø§ÛŒØ´ Ù¾Ø§Ø³Ø®
        displayResponse(response.data);
        
        // ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ù…ÙˆÙÙ‚ alert Ù†Ù…Ø§ÛŒØ´ Ø¨Ø¯Ù‡
        if (response.data.is_success) {
            console.log('âœ… Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù…ÙˆÙÙ‚ - Ø¨Ø¯ÙˆÙ† alert');
        } else {
            console.log('âŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù†Ø§Ù…ÙˆÙÙ‚ - response Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯');
        }
        
        // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¢Ù…Ø§Ø±
        try {
            await loadDashboardStats();
        } catch (statsError) {
            console.warn('âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¢Ù…Ø§Ø±:', statsError);
        }
        
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª:', error);
        console.error('ğŸ“‹ Ø¬Ø²Ø¦ÛŒØ§Øª Ø®Ø·Ø§:', {
            message: error.message,
            response: error.response?.data,
            status: error.response?.status,
            config: error.config
        });
        
        let errorMessage = 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª';
        let errorDetails = {};
        
        if (error.response) {
            // Ø®Ø·Ø§ÛŒ HTTP
            errorMessage = `Ø®Ø·Ø§ÛŒ HTTP ${error.response.status}`;
            errorDetails = error.response.data || {};
            
            if (error.response.status === 0) {
                errorMessage = 'Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±';
            } else if (error.response.status === 404) {
                errorMessage = 'Ø¢Ø¯Ø±Ø³ API ÛŒØ§ÙØª Ù†Ø´Ø¯';
            } else if (error.response.status === 500) {
                errorMessage = 'Ø®Ø·Ø§ÛŒ Ø¯Ø§Ø®Ù„ÛŒ Ø³Ø±ÙˆØ±';
            } else if (error.response.data?.error) {
                errorMessage = error.response.data.error;
            }
        } else if (error.request) {
            // Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡
            errorMessage = 'Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ± - Ù„Ø·ÙØ§Ù‹ Ø§ØªØµØ§Ù„ Ø§ÛŒÙ†ØªØ±Ù†Øª Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯';
        } else {
            // Ø®Ø·Ø§ÛŒ Ø¯ÛŒÚ¯Ø±
            errorMessage = error.message || 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ';
        }
        
        // Ù†Ù…Ø§ÛŒØ´ Ø®Ø·Ø§ Ø¯Ø± response section
        displayResponse({
            is_success: false,
            status_code: error.response?.status || 'Ø®Ø·Ø§',
            response_time: null,
            response_size: null,
            response_body: JSON.stringify({
                error: errorMessage,
                details: errorDetails,
                url: url,
                method: method,
                timestamp: new Date().toISOString(),
                debug: {
                    axios_error: error.message,
                    has_response: !!error.response,
                    has_request: !!error.request
                }
            }, null, 2),
            response_headers: error.response?.headers || {}
        });
        
        // ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ø®Ø·Ø§Ù‡Ø§ÛŒ Ø§ØªØµØ§Ù„ ÛŒØ§ validation alert Ù†Ù…Ø§ÛŒØ´ Ø¨Ø¯Ù‡
        if (!error.response) {
            // Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡ ÛŒØ§ Ø§ØªØµØ§Ù„
            showAlert('Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„: ' + errorMessage, 'error', 5000);
        } else if (error.response.status >= 500) {
            // Ø®Ø·Ø§ÛŒ Ø³Ø±ÙˆØ± Ú©Ù‡ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ú©Ø¯ Ø¨Ø§Ø´Ø¯
            console.log('ğŸ”§ Ø®Ø·Ø§ÛŒ Ø³Ø±ÙˆØ±:', errorMessage);
        } else {
            // Ø®Ø·Ø§Ù‡Ø§ÛŒ HTTP Ø¹Ø§Ø¯ÛŒ Ú©Ù‡ Ø¯Ø± response Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯
            console.log('ğŸ“‹ Ø®Ø·Ø§ÛŒ HTTP:', error.response.status, errorMessage);
        }
    } finally {
        console.log('ğŸ Ù¾Ø§ÛŒØ§Ù† Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¯Ø±Ø®ÙˆØ§Ø³Øª');
        isRequestInProgress = false;
        sendBtn.disabled = false;
        sendBtn.innerHTML = originalText;
    }
}

// Ø³Ø§Ø²Ù†Ø¯Ù‡ JSON Ø³Ø§Ø¯Ù‡
function createSimpleJsonBuilder() {
    const key = prompt('Ù†Ø§Ù… Ú©Ù„ÛŒØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:', 'name');
    const value = prompt('Ù…Ù‚Ø¯Ø§Ø± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:', 'value');
    
    if (key && value) {
        const result = {};
        result[key] = value;
        document.getElementById('body-raw').value = JSON.stringify(result, null, 2);
        showAlert('JSON Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯!', 'success');
    }
}

// Ù†Ù…Ø§ÛŒØ´ Ù¾Ø§Ø³Ø®
function displayResponse(result) {
    const responseSection = document.getElementById('response-section');
    const statusElement = document.getElementById('response-status');
    const timeElement = document.getElementById('response-time');
    const sizeElement = document.getElementById('response-size');
    const bodyElement = document.getElementById('response-body-content');
    const headersElement = document.getElementById('response-headers-content');
    
    // Ù†Ù…Ø§ÛŒØ´ section
    responseSection.style.display = 'block';
    
    // ØªÙ†Ø¸ÛŒÙ… Ú©Ù„Ø§Ø³ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…ÙˆÙÙ‚ÛŒØª ÛŒØ§ Ø®Ø·Ø§
    if (result.is_success) {
        responseSection.className = 'response-section';
        responseSection.querySelector('i').className = 'bi bi-arrow-down-circle text-success';
    } else {
        responseSection.className = 'response-section error';
        responseSection.querySelector('i').className = 'bi bi-arrow-down-circle text-danger';
    }
    
    // Ù†Ù…Ø§ÛŒØ´ Ø¢Ù…Ø§Ø±
    statusElement.textContent = result.status_code || 'Ø®Ø·Ø§';
    statusElement.className = `fw-bold ${result.is_success ? 'text-success' : 'text-danger'}`;
    
    timeElement.textContent = formatResponseTime(result.response_time);
    sizeElement.textContent = result.response_size ? (result.response_size + ' Ø¨Ø§ÛŒØª') : '-';
    
    // Ù†Ù…Ø§ÛŒØ´ Ø¨Ø¯Ù†Ù‡ Ù¾Ø§Ø³Ø®
    try {
        const jsonData = JSON.parse(result.response_body);
        bodyElement.textContent = JSON.stringify(jsonData, null, 2);
    } catch (e) {
        bodyElement.textContent = result.response_body || 'Ù¾Ø§Ø³Ø®ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ù†Ø´Ø¯';
    }
    
    // Ù†Ù…Ø§ÛŒØ´ Ù‡Ø¯Ø±Ù‡Ø§ÛŒ Ù¾Ø§Ø³Ø®
    if (result.response_headers && typeof result.response_headers === 'object') {
        headersElement.textContent = JSON.stringify(result.response_headers, null, 2);
    } else {
        headersElement.textContent = 'Ù‡Ø¯Ø±ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ù†Ø´Ø¯';
    }
    
    // Ø§Ø³Ú©Ø±ÙˆÙ„ Ø¨Ù‡ Ù¾Ø§Ø³Ø®
    responseSection.scrollIntoView({ behavior: 'smooth' });
}

// Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù¾Ø§Ø³Ø®
document.addEventListener('click', function(e) {
    if (e.target.closest('#clear-response')) {
        document.getElementById('response-section').style.display = 'none';
    }
});

// Ø¯Ú©Ù…Ù‡ ØªØ³Øª
document.getElementById('test-btn').addEventListener('click', async function() {
    console.log('ğŸ”§ Ø¯Ú©Ù…Ù‡ ØªØ³Øª Ú©Ù„ÛŒÚ© Ø´Ø¯');
    
    // Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§ÙˆÙ„ÛŒÙ‡
    console.log('User authenticated:', '{{ user.is_authenticated|yesno:"yes,no" }}');
    console.log('CSRF token:', document.querySelector('[name=csrfmiddlewaretoken]')?.value);
    console.log('Axios available:', typeof axios !== 'undefined');
    
    try {
        // ØªØ³Øª Ø³Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ dashboard stats
        console.log('ØªØ³Øª Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±...');
        const response = await axios.get('/request/api/dashboard-stats/');
        console.log('Ù¾Ø§Ø³Ø® dashboard stats:', response.data);
        
        // Ù†Ù…Ø§ÛŒØ´ response Ø³Ø§Ø¯Ù‡
        displayResponse({
            is_success: true,
            status_code: 200,
            response_time: '50ms',
            response_size: 250,
            response_body: JSON.stringify({
                message: 'ØªØ³Øª Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ± Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯',
                data: response.data,
                timestamp: new Date().toISOString()
            }, null, 2),
            response_headers: {
                'content-type': 'application/json',
                'server': 'Django'
            }
        });
        
        showAlert('ØªØ³Øª Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ± Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯!', 'success');
        
    } catch (error) {
        console.error('Ø®Ø·Ø§ Ø¯Ø± ØªØ³Øª:', error);
        
        displayResponse({
            is_success: false,
            status_code: error.response?.status || 'Ø®Ø·Ø§',
            response_time: null,
            response_size: null,
            response_body: JSON.stringify({
                error: 'Ø®Ø·Ø§ Ø¯Ø± ØªØ³Øª Ø§Ø±ØªØ¨Ø§Ø·',
                message: error.message,
                details: error.response?.data || {},
                config: {
                    url: error.config?.url,
                    method: error.config?.method
                }
            }, null, 2),
            response_headers: error.response?.headers || {}
        });
        
        showAlert('Ø®Ø·Ø§ Ø¯Ø± ØªØ³Øª Ø§Ø±ØªØ¨Ø§Ø·: ' + error.message, 'error');
    }
});

// Ø¯Ú©Ù…Ù‡ Ù¾Ø± Ú©Ø±Ø¯Ù† Ø³Ø±ÛŒØ¹ URL ØªØ³Øª
document.getElementById('quick-fill-btn').addEventListener('click', function() {
    console.log('âš¡ Ù¾Ø± Ú©Ø±Ø¯Ù† Ø³Ø±ÛŒØ¹ URL Ù†Ù…ÙˆÙ†Ù‡');
    
    const urlInput = document.getElementById('url');
    if (urlInput) {
        urlInput.value = 'https://jsonplaceholder.typicode.com/posts/1';
        urlInput.focus();
        showAlert('URL Ù†Ù…ÙˆÙ†Ù‡ ÙˆØ§Ø±Ø¯ Ø´Ø¯ - Ø­Ø§Ù„Ø§ Ø±ÙˆÛŒ Ø§Ø±Ø³Ø§Ù„ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯', 'info', 3000);
        console.log('âœ… URL Ù†Ù…ÙˆÙ†Ù‡ Ø¯Ø± input Ù‚Ø±Ø§Ø± Ú¯Ø±ÙØª');
        
        // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ URL Ù†Ù‡Ø§ÛŒÛŒ
        updateFinalUrl();
    } else {
        console.error('âŒ ÙÛŒÙ„Ø¯ URL ÛŒØ§ÙØª Ù†Ø´Ø¯');
        showAlert('Ø®Ø·Ø§ Ø¯Ø± ÛŒØ§ÙØªÙ† ÙÛŒÙ„Ø¯ URL', 'error');
    }
});

// Ø¯Ú©Ù…Ù‡ ØªØ³Øª Navigation
document.getElementById('test-nav-btn').addEventListener('click', function() {
    console.log('ğŸ› Ø´Ø±ÙˆØ¹ ØªØ³Øª Ø¬Ø§Ù…Ø¹ Navigation...');
    
    const testResults = {
        total: 0,
        working: 0,
        failed: 0,
        details: [],
        clickTests: []
    };
    
    // Ø¨Ø±Ø±Ø³ÛŒ Ù‡Ù…Ù‡ Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ÛŒ navigation
    const navLinks = document.querySelectorAll('.sidebar .nav-link:not(.disabled)');
    console.log(`ğŸ” Testing ${navLinks.length} navigation links...`);
    
    testResults.total = navLinks.length;
    
    // ØªØ³Øª 1: URL Accessibility
    console.log('ğŸ“¡ Phase 1: Testing URL accessibility...');
    navLinks.forEach((link, index) => {
        const href = link.getAttribute('href');
        const text = link.textContent.trim();
        
        if (href && href !== '#' && href !== '') {
            fetch(href, { method: 'HEAD' })
                .then(response => {
                    const status = response.ok ? 'âœ… OK' : 'âŒ Failed';
                    console.log(`   ${index + 1}. "${text}" (${href}) -> ${response.status} ${status}`);
                    
                    if (response.ok) {
                        testResults.working++;
                    } else {
                        testResults.failed++;
                    }
                    
                    testResults.details.push({
                        text,
                        href,
                        status: response.status,
                        ok: response.ok
                    });
                    
                    // Ø§Ú¯Ø± Ù‡Ù…Ù‡ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ URL ØªÙ…Ø§Ù… Ø´Ø¯ØŒ ØªØ³Øª Ú©Ù„ÛŒÚ© Ø±Ùˆ Ø´Ø±ÙˆØ¹ Ú©Ù†
                    if (testResults.details.length === testResults.total) {
                        testClickBehavior(navLinks, testResults);
                    }
                })
                .catch(error => {
                    console.log(`   ${index + 1}. "${text}" (${href}) -> ERROR: ${error.message} âŒ`);
                    testResults.failed++;
                    testResults.details.push({
                        text,
                        href,
                        status: 'ERROR',
                        ok: false,
                        error: error.message
                    });
                    
                    if (testResults.details.length === testResults.total) {
                        testClickBehavior(navLinks, testResults);
                    }
                });
        }
    });
    
    if (testResults.total === 0) {
        showAlert('Ù‡ÛŒÚ† Ù„ÛŒÙ†Ú© navigation Ù‚Ø§Ø¨Ù„ ØªØ³Øª ÛŒØ§ÙØª Ù†Ø´Ø¯!', 'warning');
        console.log('âš ï¸ No testable navigation links found');
    }
});

// ØªØ³Øª Ø±ÙØªØ§Ø± Ú©Ù„ÛŒÚ©
function testClickBehavior(navLinks, testResults) {
    console.log('ğŸ–±ï¸ Phase 2: Testing click behavior...');
    
    navLinks.forEach((link, index) => {
        const href = link.getAttribute('href');
        const text = link.textContent.trim();
        
        // Ø¨Ø±Ø±Ø³ÛŒ ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ù„ÛŒÙ†Ú©
        const linkInfo = {
            text,
            href,
            hasHref: !!href && href !== '#',
            isDisabled: link.classList.contains('disabled'),
            hasClickHandler: !!link.onclick,
            pointerEvents: window.getComputedStyle(link).pointerEvents,
            cursor: window.getComputedStyle(link).cursor
        };
        
        console.log(`   Link ${index + 1}: "${text}"`, linkInfo);
        testResults.clickTests.push(linkInfo);
    });
    
    // Ù†Ù…Ø§ÛŒØ´ Ù†ØªØ§ÛŒØ¬ Ù†Ù‡Ø§ÛŒÛŒ
    displayNavigationTestResults(testResults);
}

// Ù†Ù…Ø§ÛŒØ´ Ù†ØªØ§ÛŒØ¬ ØªØ³Øª navigation
function displayNavigationTestResults(results) {
    console.log('ğŸ“Š Navigation Test Results:');
    console.log(`   Total: ${results.total}`);
    console.log(`   Working: ${results.working}`);
    console.log(`   Failed: ${results.failed}`);
    
    const successRate = results.total > 0 ? ((results.working / results.total) * 100).toFixed(1) : 0;
    
    let message = `ØªØ³Øª Navigation: ${results.working}/${results.total} Ù…ÙˆÙÙ‚ (${successRate}%)`;
    let alertType = 'info';
    
    if (results.working === results.total) {
        message = `Ù‡Ù…Ù‡ Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ÛŒ Navigation Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ù†Ø¯! âœ…`;
        alertType = 'success';
    } else if (results.failed > 0) {
        message = `${results.failed} Ù„ÛŒÙ†Ú© Navigation Ù…Ø´Ú©Ù„ Ø¯Ø§Ø±Ø¯ âŒ`;
        alertType = 'error';
    }
    
    // Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø´Ú©Ù„Ø§Øª Ú©Ù„ÛŒÚ©
    const clickIssues = results.clickTests.filter(test => 
        test.pointerEvents === 'none' || 
        test.cursor === 'not-allowed' || 
        !test.hasHref ||
        test.isDisabled
    );
    
    // Ù†Ù…Ø§ÛŒØ´ Ø¯Ø± response section
    displayResponse({
        is_success: results.working === results.total && clickIssues.length === 0,
        status_code: 'Test Results',
        response_time: null,
        response_size: null,
        response_body: JSON.stringify({
            message: 'Navigation Test Results',
            summary: {
                total: results.total,
                working: results.working,
                failed: results.failed,
                success_rate: successRate + '%',
                click_issues: clickIssues.length
            },
            url_tests: results.details,
            click_tests: results.clickTests,
            possible_issues: clickIssues,
            recommendations: clickIssues.length > 0 ? [
                'Check CSS pointer-events property',
                'Verify href attributes',
                'Check for JavaScript preventDefault calls',
                'Ensure links are not disabled'
            ] : ['All navigation links appear to be working correctly'],
            timestamp: new Date().toISOString()
        }, null, 2),
        response_headers: {
            'test-type': 'navigation-comprehensive',
            'test-status': results.working === results.total && clickIssues.length === 0 ? 'all-pass' : 'issues-found'
        }
    });
    
    showAlert(message, alertType, 5000);
}
</script>
{% endblock %} 